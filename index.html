<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENG NPC 68 Challenge</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="app-container">
        <div id="initial-loader" style="text-align: center; padding-top: 100px; font-size: 1.2em; color: white;">
          <i class="fas fa-spinner fa-spin"></i> Loading Challenge...
        </div>
        <div id="main-content-wrapper" style="display: none; height: 100%; flex-direction: column;"></div>
    </div>
    
    <div id="modals-container"></div>
    <div id="toast-container"></div>

<script>
    // ======================================================
    // CONFIGURATION & GLOBAL VARIABLES
    // ======================================================
    const SUPABASE_URL = 'https://nmykdendjmttjvvtsuxk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5teWtkZW5kam10dGp2dnRzdXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mzk4MTksImV4cCI6MjA2ODMxNTgxOX0.gp1hzku2fDBH_9PvMsDCIwlkM0mssuke40smgU4-paE';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const DEFAULT_AVATAR = 'https://i.ibb.co/RkgFJztg/AVATAR.jpg';
    
    let currentUser = null;
    let fullSummaryData = [], filteredSummaryData = [];
    let allMissions = [], allBadges = [];
    let currentUserSubmissions = new Map();
    let currentMission = null;

    // ======================================================
    // INITIALIZATION
    // ======================================================
    window.addEventListener('load', initializeApp);

    function getGradeConfigFromUrl() {
        const hostname = window.location.hostname;
        if (hostname.includes('eng-m1')) return { level: 'ม.1', title: 'M.1' };
        if (hostname.includes('eng-m2')) return { level: 'ม.2', title: 'M.2' };
        return { level: 'ม.3', title: 'M.3' };
    }

    async function initializeApp() {
        const config = getGradeConfigFromUrl();
        document.title = `ENG ${config.title} Challenge`;
        buildApp();
        initializeUserFromStorage();
        await loadInitialData();
    }

    // ======================================================
    // DATA FETCHING
    // ======================================================
    async function loadInitialData() {
        const config = getGradeConfigFromUrl();
        try {
            const [leaderboardRes, missionsRes, submissionsRes] = await Promise.all([
                supabaseClient.from('users').select('*').eq('role', 'student').eq('level', config.level).order('total_score', { ascending: false, nullsFirst: false }),
                supabaseClient.from('missions').select('*').eq('level', config.level).order('id', { ascending: true }),
                currentUser ? supabaseClient.from('submissions').select('mission_id, score').eq('user_id', currentUser.id) : Promise.resolve({ data: [] })
            ]);

            if (leaderboardRes.error) throw leaderboardRes.error;
            if (missionsRes.error) throw missionsRes.error;
            if (submissionsRes.error) throw submissionsRes.error;

            const totalPossiblePoints = missionsRes.data.reduce((sum, m) => sum + (m.max_points || 0), 0);
            fullSummaryData = leaderboardRes.data.map((user, index) => {
                const progress = totalPossiblePoints > 0 ? Math.round(((user.total_score || 0) / totalPossiblePoints) * 100) : 0;
                return { ...user, rank: index + 1, progress: progress };
            });
            filteredSummaryData = fullSummaryData;
            allMissions = missionsRes.data;
            currentUserSubmissions = new Map((submissionsRes.data || []).map(s => [s.mission_id, s]));
            
            updateUI();
        } catch (error) {
            showError(error);
        } finally {
            document.getElementById('initial-loader').style.display = 'none';
            document.getElementById('main-content-wrapper').style.display = 'flex';
        }
    }

    // ======================================================
    // UI BUILDING & RENDERING
    // ======================================================
    function buildApp() {
        const mainContent = document.getElementById('main-content-wrapper');
        const config = getGradeConfigFromUrl();
        mainContent.innerHTML = `
            <header class="app-header">
                <div class="header-title">
                    <div class="title-main">NONPAKCHEE ENGLISH QUEST</div>
                    <div class="title-sub">${config.title} ADVENTURE 2025</div>
                </div>
                <div class="app-nav">
                    <button class="nav-button active" onclick="switchView('leaderboard-view', this)">Leaderboard</button>
                    <button class="nav-button" onclick="switchView('mission-map-view', this)">Mission Map</button>
                </div>
                <button id="profile-button"></button>
            </header>
            <div class="view-container">
                <div id="leaderboard-view" class="view active">
                    <section id="podium-section" class="podium-container"></section>
                    <ul id="roster-list" class="roster-list"></ul>
                </div>
                <div id="mission-map-view" class="view"></div>
            </div>`;
        
        const modalsContainer = document.getElementById('modals-container');
        modalsContainer.innerHTML = `
            <div id="student-detail-modal" class="modal-overlay"><div class="modal-box"><div class="detail-modal-close" onclick="closeModal('student-detail-modal')">×</div><div class="detail-modal-header"><img id="detail-modal-pic" class="detail-modal-pic"><div class="detail-modal-info"><h3 id="detail-modal-name"></h3><p id="detail-modal-score"></p></div></div><div id="detail-modal-body" class="detail-modal-body"></div></div></div>
            <div id="login-modal" class="modal-overlay"><div class="modal-box"><h2>Login</h2><div id="login-error" class="modal-error"></div><input type="text" id="username-input" placeholder="Username"><input type="password" id="password-input" placeholder="Password"><button class="btn-primary" onclick="handleLogin()">Enter</button><button class="btn-secondary" onclick="closeModal('login-modal')">Close</button></div></div>
            <div id="profile-modal" class="modal-overlay"><div class="modal-box"><h2>My Profile</h2><img id="profile-preview" src=""><h3 id="profile-name"></h3><p id="profile-score-text"></p><div id="profile-message" class="modal-message"></div><label for="image-upload-input" class="btn-primary">Change Avatar</label><input type="file" id="image-upload-input" accept="image/png,image/jpeg"><button class="btn-danger" onclick="handleLogout()">Logout</button><button class="btn-secondary" onclick="closeModal('profile-modal')">Close</button></div></div>
            <div id="mission-detail-modal" class="modal-overlay"><div class="modal-box"><div class="detail-modal-close" onclick="closeModal('mission-detail-modal')">×</div><h2 id="modal-mission-topic"></h2><div id="modal-mission-body"></div><div id="modal-mission-actions"></div></div></div>
            <div id="submission-modal" class="modal-overlay"><div class="modal-box"><div class="detail-modal-close" onclick="closeModal('submission-modal')">×</div><h2>Submit Mission: <span id="submission-modal-topic"></span></h2><div id="submission-form-area"><label for="submission-link">Link:</label><input type="url" id="submission-link" placeholder="https://..."><label for="submission-file">Upload File:</label><input type="file" id="submission-file"><div id="submission-error" class="modal-error"></div></div><div id="submission-loader" style="display:none;text-align:center;"><i class="fas fa-spinner fa-spin fa-2x"></i><p id="submission-loader-text"></p></div><div id="submission-buttons"><button class="btn-primary" onclick="handleSubmitMission()">Submit</button><button class="btn-secondary" onclick="closeModal('submission-modal')">Cancel</button></div></div></div>`;
        
        document.getElementById('profile-button').addEventListener('click', handleUserAreaClick);
        document.getElementById('image-upload-input').addEventListener('change', handleProfileUpdate);
    }
    
    function updateUI() {
        updateUserUI();
        const activeView = document.querySelector('.view.active');
        if (activeView && activeView.id === 'leaderboard-view') {
            renderStudentList();
        } else if (activeView && activeView.id === 'mission-map-view') {
            renderMapView();
        }
    }

    function renderStudentList() {
        const podiumContainer = document.getElementById('podium-section');
        const rosterList = document.getElementById('roster-list');
        if (!podiumContainer || !rosterList) return;

        const top3 = filteredSummaryData.slice(0, 3);
        const others = filteredSummaryData.slice(3);
        const podiumStands = { 1: '', 2: '', 3: '' };
        
        top3.forEach(student => {
            const profilePic = student.profile_url || DEFAULT_AVATAR;
            const rankMeta = {
                1: { class: 'gold', icon: '' }, // Crown is now in CSS
                2: { class: 'silver', icon: '2' },
                3: { class: 'bronze', icon: '3' }
            };
            podiumStands[student.rank] = `
                <div class="podium-card rank-${student.rank}" onclick="showStudentDetailModal('${student.id}')">
                    <div class="podium-rank ${rankMeta[student.rank].class}">${rankMeta[student.rank].icon}</div>
                    <img src="${profilePic}" class="podium-pic" onerror="this.onerror=null;this.src='${DEFAULT_AVATAR}';">
                    <div class="podium-name">${student.name}</div>
                    <div class="podium-score">${student.total_score || 0} PTS</div>
                </div>`;
        });
        podiumContainer.innerHTML = podiumStands[2] + podiumStands[1] + podiumStands[3];

        rosterList.innerHTML = others.map(student => {
            const profilePic = student.profile_url || DEFAULT_AVATAR;
            const isSelf = currentUser && currentUser.id === student.id;
            return `
                <li class="roster-row ${isSelf ? 'is-self' : ''}" onclick="showStudentDetailModal('${student.id}')">
                    <div class="cell-rank">${student.rank}</div>
                    <img src="${profilePic}" class="cell-player-pic" onerror="this.onerror=null;this.src='${DEFAULT_AVATAR}';">
                    <div class="cell-player-name">${student.name}</div>
                    <div class="cell-progress">
                         <div class="progress-container"><div class="progress-bar" style="width: ${student.progress}%;"></div></div>
                    </div>
                    <div class="cell-score">${student.total_score || 0} PTS</div>
                </li>`;
        }).join('');
    }
    
    // ======================================================
    // USER MANAGEMENT
    // ======================================================
    function initializeUserFromStorage() {
        const userJson = localStorage.getItem('leaderboardUser');
        if (userJson) {
            try {
                const parsedData = JSON.parse(userJson);
                if (typeof parsedData === 'object' && parsedData.id) currentUser = parsedData;
                else throw new Error("Invalid stored user format.");
            } catch (e) {
                localStorage.removeItem('leaderboardUser');
                currentUser = null;
            }
        }
    }

    async function handleLogin() {
        const username = document.getElementById('username-input').value.trim();
        const password = document.getElementById('password-input').value.trim();
        const errorEl = document.getElementById('login-error');
        if (!username || !password) { errorEl.innerText = "Please enter all fields."; return; }
        errorEl.innerText = "Checking...";
        const { data, error } = await supabaseClient.from('users').select('*').eq('username', username).eq('password', password).single();
        if (error || !data) {
            errorEl.innerText = "Invalid username or password.";
        } else {
            localStorage.setItem('leaderboardUser', JSON.stringify(data));
            location.reload(); 
        }
    }

    function handleLogout() {
        localStorage.removeItem('leaderboardUser');
        location.reload();
    }
    
    async function handleProfileUpdate(event) {
        const file = event.target.files[0];
        if (!file || !currentUser) return;
        const profileMessage = document.getElementById('profile-message');
        profileMessage.innerText = 'Uploading...';
        try {
            const fileName = `${currentUser.id}/${Date.now()}_${file.name}`;
            const { error: uploadError } = await supabaseClient.storage.from('profile-pictures').upload(fileName, file, { cacheControl: '3600', upsert: true });
            if (uploadError) throw uploadError;
            const { data } = supabaseClient.storage.from('profile-pictures').getPublicUrl(fileName);
            const { error: updateError } = await supabaseClient.from('users').update({ profile_url: data.publicUrl }).eq('id', currentUser.id);
            if (updateError) throw updateError;
            showToast("Avatar updated! Reloading...");
            currentUser.profile_url = data.publicUrl;
            localStorage.setItem('leaderboardUser', JSON.stringify(currentUser));
            setTimeout(() => location.reload(), 1500);
        } catch (error) {
            profileMessage.innerText = '';
            showToast(`Upload failed: ${error.message}`, true);
        } finally {
            event.target.value = '';
        }
    }
    
    function updateUserUI() {
        const profileBtn = document.getElementById('profile-button');
        const profileModalPreview = document.getElementById('profile-preview');
        if (!profileBtn) return;
        
        if (currentUser) {
            profileBtn.innerHTML = `<img src="${currentUser.profile_url || DEFAULT_AVATAR}" onerror="this.onerror=null;this.src='${DEFAULT_AVATAR}';">`;
            if (profileModalPreview) {
                profileModalPreview.src = currentUser.profile_url || DEFAULT_AVATAR;
                document.getElementById('profile-name').innerText = currentUser.name;
                const userRecord = fullSummaryData.find(s => s.id === currentUser.id);
                document.getElementById('profile-score-text').innerText = `Total Score: ${userRecord ? userRecord.total_score || 0 : 'N/A'}`;
            }
        } else {
            profileBtn.innerHTML = `<img src="${DEFAULT_AVATAR}">`;
        }
    }

    // ======================================================
    // MISSION & SUBMISSION
    // ======================================================
    async function handleSubmitMission() {
        if (!currentUser || !currentMission) { showToast("Error: User or Mission data not found", true); return; }
        const errorEl = document.getElementById('submission-error');
        const link = document.getElementById('submission-link').value.trim();
        const fileInput = document.getElementById('submission-file');
        const file = fileInput.files[0];
        if (!link && !file) { errorEl.innerText = 'Please provide a link or a file.'; return; }
        const loader = document.getElementById('submission-loader'), loaderText = document.getElementById('submission-loader-text');
        document.getElementById('submission-form-area').style.display = 'none';
        document.getElementById('submission-buttons').style.display = 'none';
        loader.style.display = 'block'; errorEl.innerText = '';
        let filePublicUrl = null;
        if (file) {
            try {
                loaderText.innerText = 'Uploading file...';
                const fileName = `${currentUser.student_id}/${currentMission.id}_${Date.now()}_${file.name}`;
                const { error: uploadError } = await supabaseClient.storage.from('mission-uploads').upload(fileName, file);
                if (uploadError) throw uploadError;
                const { data } = supabaseClient.storage.from('mission-uploads').getPublicUrl(fileName);
                filePublicUrl = data.publicUrl;
            } catch (error) {
                errorEl.innerText = `Upload failed: ${error.message}`;
                document.getElementById('submission-form-area').style.display = 'block';
                document.getElementById('submission-buttons').style.display = 'block';
                loader.style.display = 'none';
                return;
            }
        }
        try {
            loaderText.innerText = 'Saving data...';
            const submissionData = { user_id: currentUser.id, mission_id: currentMission.id, submission_link: link, proof_url: filePublicUrl };
            const { error } = await supabaseClient.from('submissions').upsert(submissionData, { onConflict: 'user_id, mission_id' });
            if (error) throw error;
            showToast("Mission Submitted!");
            closeModal('submission-modal');
            await loadInitialData();
        } catch (error) {
            errorEl.innerText = `Save failed: ${error.message}`;
            document.getElementById('submission-form-area').style.display = 'block';
            document.getElementById('submission-buttons').style.display = 'block';
            loader.style.display = 'none';
        }
    }
    
    // ======================================================
    // UI UTILITIES & EVENT HANDLERS
    // ======================================================
    function renderMapView() {
        const container = document.getElementById('mission-map-view');
        if (!container) return;
        if (!currentUser) { container.innerHTML = `<div class="login-overlay-wrapper"><div class="login-overlay-content"><h3>PLEASE LOGIN</h3><p>to see your mission status.</p><button class="btn-primary" onclick="openModal('login-modal')">LOGIN</button></div></div>`; return; }
        const pathHTML = allMissions.map((mission, index) => {
             const sub = currentUserSubmissions.get(mission.id);
             let statusClass = 'locked', icon = '<i class="fas fa-lock"></i>';
             const today = new Date(); today.setHours(0,0,0,0);
             if (new Date(mission.assigned_date) <= today) {
                statusClass = 'available';
                icon = `<i class="fas fa-star"></i>`;
             }
             if (sub && sub.score !== null) { statusClass = 'completed'; icon = '✔️'; }
             else if (sub) { statusClass = 'pending'; icon = '⌛'; }
             const alignClass = index % 2 === 0 ? 'align-left' : 'align-right';
             return `<div class="mission-node ${statusClass} ${alignClass}" onclick="showMissionDetail(${mission.id})"><div class="mission-node-icon">${icon}</div><div class="mission-node-topic">${mission.topic}</div></div>`;
        }).join('');
        container.innerHTML = `<div class="mission-path">${pathHTML || 'No missions available.'}</div>`;
    }

    function showMissionDetail(missionId) {
        currentMission = allMissions.find(m => m.id === missionId);
        if (!currentMission) return;
        const m = currentMission;
        document.getElementById('modal-mission-topic').innerText = m.topic;
        document.getElementById('modal-mission-body').innerHTML = `<p><strong>Objective:</strong> ${m.detail || '(None)'}</p><p><strong>Deadline:</strong> ${new Date(m.due_date).toLocaleDateString('th-TH')}</p><p><strong>Reward:</strong> ${m.max_points} PTS</p><hr><p><strong>Status:</strong> <span id="modal-mission-user-status"></span></p>`;
        const sub = currentUserSubmissions.get(m.id);
        const statusEl = document.getElementById('modal-mission-user-status');
        const actionsEl = document.getElementById('modal-mission-actions');
        let actionsHtml = `<button class="btn-secondary" onclick="closeModal('mission-detail-modal')">CLOSE</button>`;
        if (sub && sub.score !== null) { statusEl.innerHTML = `<span style="color:var(--status-success);">GRADED (${sub.score}/${m.max_points}) ✔️</span>`; } 
        else if (sub) { statusEl.innerHTML = `<span style="color:var(--accent-yellow);">SUBMITTED ⌛</span>`; actionsHtml = `<button class="btn-primary" onclick="openSubmissionModal()">EDIT SUBMISSION</button>${actionsHtml}`; } 
        else { statusEl.innerHTML = `<span>NOT SUBMITTED</span>`; actionsHtml = `<button class="btn-primary" onclick="openSubmissionModal()">SUBMIT</button>${actionsHtml}`; }
        actionsEl.innerHTML = actionsHtml;
        openModal('mission-detail-modal');
    }

    function openSubmissionModal() {
        if (!currentMission) return;
        document.getElementById('submission-modal-topic').innerText = currentMission.topic;
        document.getElementById('submission-link').value = '';
        document.getElementById('submission-file').value = '';
        document.getElementById('submission-error').innerText = '';
        closeModal('mission-detail-modal');
        openModal('submission-modal');
    }
    
    async function showStudentDetailModal(userId) {
        const student = fullSummaryData.find(s => s.id === userId);
        if (!student) return;
        document.getElementById('detail-modal-pic').src = `${student.profile_url || DEFAULT_AVATAR}`;
        document.getElementById('detail-modal-name').innerText = student.name;
        document.getElementById('detail-modal-score').innerText = `Total Score: ${student.total_score || 0}`;
        const body = document.getElementById('detail-modal-body');
        body.innerHTML = '<div style="text-align:center;padding:20px;">Loading Stats...</div>';
        openModal('student-detail-modal');
        const { data, error } = await supabaseClient.from('submissions').select('missions(topic, max_points), score').eq('user_id', userId);
        if (error) { body.innerHTML = `<p style="color:var(--status-danger)">Error: ${error.message}</p>`; return; }
        let tableHtml = '<table class="detail-table"><thead><tr><th>MISSION</th><th style="text-align:center;">STATUS</th><th style="text-align:right;">SCORE</th></tr></thead><tbody>';
        allMissions.forEach(mission => {
            const sub = data.find(s => s.missions && s.missions.topic === mission.topic);
            let statusText = 'Not Submitted', scoreText = `0 / ${mission.max_points}`, statusClass = 'not-submitted';
            if(sub) {
                if (sub.score !== null) { statusClass = 'graded'; statusText = `✔️ Graded`; scoreText = `${sub.score} / ${mission.max_points}`; }
                else { statusClass = 'pending'; statusText = '⌛ Pending'; scoreText = `- / ${mission.max_points}`; }
            }
            tableHtml += `<tr><td>${mission.topic}</td><td class="status ${statusClass}" align="center">${statusText}</td><td align="right">${scoreText}</td></tr>`;
        });
        body.innerHTML = tableHtml + '</tbody></table>';
    }

    function switchView(viewId, element) {
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        element.classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId)?.classList.add('active');
        updateUI();
    }
    
    function showToast(message, isError = false) { /* ... same as before ... */ }
    function showError(error) { /* ... same as before ... */ }
    function handleUserAreaClick() { currentUser ? openModal("profile-modal") : openModal("login-modal"); }
    function openModal(id) { document.getElementById(id)?.classList.add("visible"); }
    function closeModal(id) { document.getElementById(id)?.classList.remove("visible"); }

    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast-notification ${isError ? 'error' : ''}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300); }, 4000);
    }

    function showError(error) {
        console.error(error);
        const errorMsg = (error && error.message) ? error.message : "An unknown error occurred.";
        document.getElementById('app-container').innerHTML = `<div style="padding:20px;text-align:center;color:#e84118;background:#fff;"><h3 style="font-family:var(--font-main)">Error</h3><p>${errorMsg}</p></div>`;
    }

</script>
</body>
</html>
