<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENG NPC 68 QUEST</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="app-container">
        <!-- Initial Loader -->
        <div id="initial-loader">
            <div class="loader-icon"><i class="fas fa-spinner"></i></div>
            <div class="loader-text">Loading Quest...</div>
        </div>

        <!-- Main App Structure -->
        <div id="main-app-wrapper" style="display: none;"></div>
    </div>
    
    <div id="modals-container"></div>
    <div id="story-viewer-container"></div>
    <div id="toast-container"></div>

<script>
    // ======================================================
    // CONFIGURATION & GLOBAL STATE
    // ======================================================
    const SUPABASE_URL = 'https://nmykdendjmttjvvtsuxk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5teWtkZW5kam10dGp2dnRzdXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mzk4MTksImV4cCI6MjA2ODMxNTgxOX0.gp1hzku2fDBH_9PvMsDCIwlkM0mssuke40smgU4-paE';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const DEFAULT_AVATAR = 'https://i.ibb.co/RkgFJztg/AVATAR.jpg';
    
    const AppState = {
        currentUser: null,
        leaderboard: [],
        missions: [],
        submissions: new Map(),
        badges: [],
        config: getGradeConfigFromUrl(),
        allSubmissionsForAdmin: [], // For admin panel
    };
    let storyTimer;

    // ======================================================
    // INITIALIZATION
    // ======================================================
    window.addEventListener('load', initializeApp);

    function getGradeConfigFromUrl() {
        const hostname = window.location.hostname;
        if (hostname.includes('eng-m1')) return { level: '‡∏°.1', title: 'M.1' };
        if (hostname.includes('eng-m2')) return { level: '‡∏°.2', title: 'M.2' };
        return { level: '‡∏°.3', title: 'M.3' };
    }

    async function initializeApp() {
        document.title = `English Quest - ${AppState.config.title}`;
        buildAppShell();
        initializeUserFromStorage();
        await loadInitialData();
        
        document.getElementById('initial-loader').style.display = 'none';
        document.getElementById('main-app-wrapper').style.display = 'flex';
    }

    // ======================================================
    // DATA FETCHING
    // ======================================================
    async function loadInitialData() {
        try {
            const [leaderboardRes, missionsRes, submissionsRes, userBadgesRes] = await Promise.all([
                supabaseClient.from('users').select('*').eq('role', 'student').eq('level', AppState.config.level).order('total_score', { ascending: false, nullsFirst: false }),
                supabaseClient.from('missions').select('*').eq('level', AppState.config.level).order('id', { ascending: true }),
                AppState.currentUser ? supabaseClient.from('submissions').select('mission_id, score').eq('user_id', AppState.currentUser.id) : Promise.resolve({ data: [] }),
                AppState.currentUser ? supabaseClient.from('user_badges').select('badges(name, description, icon_url)').eq('user_id', AppState.currentUser.id) : Promise.resolve({ data: [] })
            ]);

            if (leaderboardRes.error) throw leaderboardRes.error;
            if (missionsRes.error) throw missionsRes.error;
            if (submissionsRes.error) throw submissionsRes.error;
            if (userBadgesRes.error) throw userBadgesRes.error;
            
            AppState.leaderboard = leaderboardRes.data;
            AppState.missions = missionsRes.data;
            AppState.submissions = new Map((submissionsRes.data || []).map(s => [s.mission_id, s]));
            AppState.badges = userBadgesRes.data.map(b => b.badges);
            
            renderMainHub();
        } catch (error) {
            showError(error);
        }
    }

    // ======================================================
    // UI SHELL & MAIN HUB
    // ======================================================
    function buildAppShell() {
        const wrapper = document.getElementById('main-app-wrapper');
        wrapper.innerHTML = `
            <header class="hub-header">
                <h1 class="header-title">English Quest</h1>
                <button id="profile-button">
                    <img src="${DEFAULT_AVATAR}" alt="Profile">
                </button>
            </header>
            <div id="main-content"></div>
        `;
        document.getElementById('profile-button').addEventListener('click', handleUserAreaClick);

        const modalsContainer = document.getElementById('modals-container');
        modalsContainer.innerHTML = `
            <div id="login-modal" class="modal-overlay"><div class="modal-box"><div class="modal-close" onclick="closeModal()">√ó</div><h2>Login</h2><form onsubmit="event.preventDefault(); handleLogin();"><div id="login-error" class="modal-error"></div><input type="text" id="username-input" placeholder="Username"><input type="password" id="password-input" placeholder="Password"><button type="submit" class="btn-primary">Enter</button></form></div></div>
            <div id="profile-modal" class="modal-overlay"><div class="modal-box profile-box"><div class="profile-header"><img id="profile-banner" src="https://i.ibb.co/L5hS0cW/space-bg.jpg"><img id="profile-avatar" class="profile-avatar"><button class="btn-change-avatar" onclick="document.getElementById('avatar-upload').click()"><i class="fas fa-camera"></i></button><input type="file" id="avatar-upload" style="display:none;" accept="image/*"></div><div class="profile-body"><h2 id="profile-name"></h2><div id="profile-title" class="profile-title"></div><div class="profile-stats"><div class="stat-item"><div id="profile-score" class="stat-value"></div><div class="stat-label">Total XP</div></div><div class="stat-item"><div id="profile-coins" class="stat-value"></div><div class="stat-label">Coins</div></div></div><hr><h3>Achievements</h3><div id="profile-badges" class="profile-badges"></div><button class="btn-danger" onclick="handleLogout()">Logout</button><button id="admin-panel-btn" class="btn-admin" style="display:none;" onclick="openAdminPanel()">Admin Panel</button></div><div class="modal-close" onclick="closeModal()">√ó</div></div></div>
            <div id="mission-modal" class="modal-overlay"><div class="modal-box"><div id="mission-modal-content"></div><div class="modal-close" onclick="closeModal()">√ó</div></div></div>
            <div id="admin-modal" class="modal-overlay admin-modal"><div class="modal-box admin-panel"><div class="admin-header"><h3><i class="fas fa-user-shield"></i> Teacher's Command Center</h3><div class="modal-close" onclick="closeModal()">√ó</div></div><div id="admin-content-container"></div></div></div>
        `;
        document.getElementById('avatar-upload').addEventListener('change', handleProfileUpdate);
    }

    function renderMainHub() {
        const mainContent = document.getElementById('main-content');
        if (!mainContent) return;

        const storyHighlightsHTML = `
            <div class="story-highlights-container">
                <div class="story-highlight-item" onclick="showStory('leaderboard')">
                    <div class="story-highlight-icon-wrapper"><div class="story-highlight-icon">üèÜ</div></div>
                    <span class="story-highlight-label">Top 3</span>
                </div>
                <div class="story-highlight-item" onclick="showStory('mission')">
                    <div class="story-highlight-icon-wrapper"><div class="story-highlight-icon">‚ú®</div></div>
                    <span class="story-highlight-label">New Mission</span>
                </div>
                 <div class="story-highlight-item" onclick="showStory('profile')">
                    <div class="story-highlight-icon-wrapper"><div class="story-highlight-icon">üìä</div></div>
                    <span class="story-highlight-label">My Stats</span>
                </div>
            </div>`;

        const activityFeedHTML = `
            <div class="activity-feed-container">
                <!-- Feed items will be rendered by JS -->
            </div>`;

        mainContent.innerHTML = storyHighlightsHTML + activityFeedHTML;
        
        renderFeed();
        updateProfileButton();
    }
    
    function renderFeed() {
        const container = document.querySelector('.activity-feed-container');
        if (!container) return;
        // Placeholder feed items
        container.innerHTML = `
            <div class="feed-item"><img src="${DEFAULT_AVATAR}" class="feed-avatar"><div><div class="feed-content"><b>Teacher</b> posted a new mission: <b>Final Project</b>!</div><div class="feed-time">1h ago</div></div></div>
            <div class="feed-item"><img src="${DEFAULT_AVATAR}" class="feed-avatar"><div><div class="feed-content"><b>John Doe</b> scored <b>100 PTS</b> on <b>Grammar Test</b>! üéâ</div><div class="feed-time">2h ago</div><div class="feed-actions"><button class="clap-button">üëè</button><span class="clap-count">5</span></div></div></div>`;
    }

    // ======================================================
    // STORY VIEWER LOGIC
    // ======================================================
    function showStory(type) {
        if (type === 'profile' && !AppState.currentUser) return openLoginModal();
        const container = document.getElementById('story-viewer-container');
        if (!container) return;

        let pagesHTML = '';
        if (type === 'leaderboard') {
            const top3 = AppState.leaderboard.slice(0, 3);
            const others = AppState.leaderboard.slice(3, 10);
            pagesHTML = `
                <div class="story-page leaderboard" data-duration="5000">
                    <div class="podium-rank-icon">üëë</div><img src="${top3[0]?.profile_url || DEFAULT_AVATAR}" class="podium-avatar"><div class="podium-name">${top3[0]?.name || 'N/A'}</div><div class="podium-score">${top3[0]?.total_score || 0} XP</div></div>
                <div class="story-page leaderboard" data-duration="5000"><div class="leaderboard-story-grid"><div><div class="podium-rank-icon">ü•à</div><img src="${top3[1]?.profile_url || DEFAULT_AVATAR}" class="podium-avatar"><div class="podium-name">${top3[1]?.name || 'N/A'}</div><div class="podium-score">${top3[1]?.total_score || 0} XP</div></div><div><div class="podium-rank-icon">ü•â</div><img src="${top3[2]?.profile_url || DEFAULT_AVATAR}" class="podium-avatar"><div class="podium-name">${top3[2]?.name || 'N/A'}</div><div class="podium-score">${top3[2]?.total_score || 0} XP</div></div></div></div>
                <div class="story-page leaderboard" data-duration="10000"><h3>Top 10 Challengers</h3><ul class="roster-story-list">${[...top3, ...others].map(user => `<li class="roster-story-item"><span class="rank">${user.rank}</span><img src="${user.profile_url || DEFAULT_AVATAR}" class="avatar"><span class="name">${user.name}</span><span class="score">${user.total_score || 0} XP</span></li>`).join('')}</ul></div>`;
        } else if (type === 'mission') {
            const latestMission = AppState.missions.find(m => new Date(m.assigned_date) <= new Date()) || AppState.missions[0] || { topic: 'No new missions' };
            pagesHTML = `<div class="story-page mission" data-duration="7000"><div class="mission-icon">‚ú®</div><h2 class="mission-title">${latestMission.topic}</h2><p class="mission-details">${latestMission.detail || ''}</p><div class="mission-info-bar"><span>üèÜ ${latestMission.max_points || 0} XP</span><span>üìÖ Due: ${latestMission.due_date ? new Date(latestMission.due_date).toLocaleDateString('th-TH') : 'N/A'}</span></div><button class="mission-button" onclick="openFullMissionMap()">View All Missions</button></div>`;
        } else if (type === 'profile') {
            pagesHTML = `<div class="story-page profile" data-duration="8000"><h2>My Stats</h2><img src="${AppState.currentUser.profile_url || DEFAULT_AVATAR}" class="podium-avatar"><h3 class="podium-name">${AppState.currentUser.name}</h3><div class="mission-info-bar" style="margin-top:20px;"><span>üöÄ ${AppState.currentUser.total_score || 0} XP</span><span>ü™ô ${AppState.currentUser.coins || 0} Coins</span></div><p>${AppState.badges.length} Achievements Unlocked</p></div>`;
        }
        
        container.innerHTML = `<div class="story-viewer-overlay visible"><div class="story-viewer-container"><div class="story-progress-bar-container"></div><div class="story-header"><div class="story-user-info"></div><div class="story-close-button" onclick="closeStory()">√ó</div></div><div class="story-nav-left" onclick="prevStory()"></div><div class="story-nav-right" onclick="nextStory()"></div>${pagesHTML}</div></div>`;
        startStoryPlayback();
    }
    
    function startStoryPlayback() {
        const pages = document.querySelectorAll('.story-page');
        if (pages.length === 0) { closeStory(); return; }
        const progressBarContainer = document.querySelector('.story-progress-bar-container');
        progressBarContainer.innerHTML = Array.from(pages).map(() => `<div class="story-progress-bar"><div class="story-progress-bar-fill"></div></div>`).join('');
        
        let currentPageIndex = 0;
        const progressBars = document.querySelectorAll('.story-progress-bar');
        
        function playPage(index) {
            if (index < 0 || index >= pages.length) { closeStory(); return; }
            currentPageIndex = index;
            pages.forEach((page, i) => page.classList.toggle('active', i === index));
            progressBars.forEach((bar, i) => {
                const fill = bar.querySelector('.story-progress-bar-fill');
                if (i < index) { fill.style.transition = 'none'; fill.style.width = '100%'; }
                else { fill.style.transition = 'none'; fill.style.width = '0%'; }
                if (i === index) {
                    const duration = pages[index].dataset.duration || 5000;
                    void fill.offsetWidth; // Reflow trick
                    fill.style.transition = `width ${duration / 1000}s linear`;
                    fill.style.width = '100%';
                    clearTimeout(storyTimer);
                    storyTimer = setTimeout(() => playPage(index + 1), duration);
                }
            });
        }
        window.nextStory = () => playPage(currentPageIndex + 1);
        window.prevStory = () => playPage(currentPageIndex - 1);
        playPage(0);
    }

        function closeStory() {
        clearTimeout(storyTimer);
        const viewer = document.querySelector('.story-viewer-overlay');
        if(viewer) {
            viewer.classList.remove('visible');
            setTimeout(() => { viewer.parentElement.innerHTML = '' }, 300); // Clear container
        }
    }

    // ======================================================
    // USER MANAGEMENT & MODALS
    // ======================================================
    function initializeUserFromStorage() {
        const userJson = localStorage.getItem('leaderboardUser');
        if (userJson) {
            try {
                const parsedData = JSON.parse(userJson);
                if (typeof parsedData === 'object' && parsedData.id) AppState.currentUser = parsedData;
            } catch (e) {
                localStorage.removeItem('leaderboardUser');
            }
        }
    }

    function updateProfileButton() {
        const profileButton = document.getElementById('profile-button');
        if (!profileButton) return;
        const img = profileButton.querySelector('img');
        if (AppState.currentUser) {
            img.src = AppState.currentUser.profile_url || DEFAULT_AVATAR;
        } else {
            img.src = DEFAULT_AVATAR;
        }
    }

    function handleUserAreaClick() {
        if(AppState.currentUser) {
            openProfileModal(AppState.currentUser.id);
        } else {
            openLoginModal();
        }
    }

    async function handleLogin() {
        const username = document.getElementById('username-input').value.trim();
        const password = document.getElementById('password-input').value.trim();
        const errorEl = document.getElementById('login-error');
        if (!username || !password) { errorEl.innerText = "Please fill all fields."; return; }
        errorEl.innerText = "Verifying...";
        const { data, error } = await supabaseClient.from('users').select('*').eq('username', username).eq('password', password).single();
        if (error || !data) {
            errorEl.innerText = "Incorrect username or password.";
        } else {
            localStorage.setItem('leaderboardUser', JSON.stringify(data));
            location.reload(); 
        }
    }
    
    function handleLogout() {
        localStorage.removeItem('leaderboardUser');
        location.reload();
    }

    async function handleProfileUpdate(event) {
        const file = event.target.files[0];
        if (!file || !AppState.currentUser) return;
        showToast('Uploading...');
        try {
            const fileName = `${AppState.currentUser.id}/${Date.now()}_${file.name}`;
            const { error: uploadError } = await supabaseClient.storage.from('profile-pictures').upload(fileName, file, { upsert: true });
            if (uploadError) throw uploadError;
            const { data } = supabaseClient.storage.from('profile-pictures').getPublicUrl(fileName);
            const { error: updateError } = await supabaseClient.from('users').update({ profile_url: data.publicUrl }).eq('id', AppState.currentUser.id);
            if (updateError) throw updateError;
            
            AppState.currentUser.profile_url = data.publicUrl;
            localStorage.setItem('leaderboardUser', JSON.stringify(AppState.currentUser));
            showToast('Avatar updated!');
            await openProfileModal(AppState.currentUser.id);
        } catch (error) {
            showToast(`Upload failed: ${error.message}`, true);
        }
    }

    async function openProfileModal(userId) {
        const { data: user, error: fetchError } = await supabaseClient.from('users').select('*').eq('id', userId).single();
        if (fetchError || !user) { showToast("Could not find user data.", true); return; }
        
        openModal('profile-modal');
        const adminBtn = document.getElementById('admin-panel-btn');
        const changeAvatarContainer = document.querySelector('.btn-change-avatar').parentElement;
        
        document.getElementById('profile-avatar').src = user.profile_url || DEFAULT_AVATAR;
        document.getElementById('profile-name').innerText = user.name;
        document.getElementById('profile-title').innerText = user.title || 'New Voyager';
        document.getElementById('profile-score').innerText = user.total_score || 0;
        document.getElementById('profile-coins').innerText = `ü™ô ${user.coins || 0}`;
        
        const isOwnProfile = AppState.currentUser && AppState.currentUser.id === userId;
        changeAvatarContainer.style.display = isOwnProfile ? 'block' : 'none';
        
        if (isOwnProfile && AppState.currentUser.role === 'admin') adminBtn.style.display = 'block';
        else adminBtn.style.display = 'none';
        
        const badgeContainer = document.getElementById('profile-badges');
        badgeContainer.innerHTML = 'Loading achievements...';
        const { data: userBadges, error } = await supabaseClient.from('user_badges').select('badges(name, description, icon_url)').eq('user_id', userId);
        if(error) { badgeContainer.innerHTML = 'Could not load achievements.'; return; }
        if(userBadges.length === 0) {
            badgeContainer.innerHTML = '<p class="no-items">No achievements yet.</p>';
            return;
        }
        badgeContainer.innerHTML = userBadges.map(b => `<div class="badge-item" title="${b.badges.name}: ${b.badges.description}"><img src="${b.badges.icon_url}" onerror="this.style.display='none'"></div>`).join('');
    }

    async function openMissionModal(missionId) {
        const mission = AppState.missions.find(m => m.id === missionId);
        if (!mission) return;
        
        const modalContent = document.getElementById('mission-modal-content');
        modalContent.innerHTML = `
            <h2>${mission.topic}</h2>
            <div class="mission-details-body">
                <p><strong>Objective:</strong> ${mission.detail || 'Complete the task as instructed.'}</p>
                <p><strong>Reward:</strong> ${mission.max_points} XP</p>
                <p><strong>Deadline:</strong> ${new Date(mission.due_date).toLocaleDateString('th-TH')}</p>
            </div>
            <div class="mission-submission-area">
                <hr>
                <h4>Submit Your Work</h4>
                <div id="mission-submission-error" class="modal-error"></div>
                <label>Link (e.g., Canva, Google Docs):</label>
                <input type="url" id="mission-submission-link" placeholder="https://...">
                <label>Or Upload a File:</label>
                <input type="file" id="mission-submission-file">
                <button class="btn-primary" onclick="handleSubmitMission(${mission.id})">Submit Mission</button>
            </div>
        `;
        openModal('mission');
    }

    async function handleSubmitMission(missionId) {
        if (!AppState.currentUser) return;
        const link = document.getElementById('mission-submission-link').value.trim();
        const file = document.getElementById('mission-submission-file').files[0];
        const errorEl = document.getElementById('mission-submission-error');
        if(!link && !file) { errorEl.innerText = 'Please provide a link or a file.'; return; }

        showToast('Submitting mission...');
        let fileUrl = null;
        if(file) {
            try {
                const fileName = `${AppState.currentUser.student_id}/${missionId}_${Date.now()}_${file.name}`;
                const { error } = await supabaseClient.storage.from('mission-uploads').upload(fileName, file);
                if(error) throw error;
                const { data } = supabaseClient.storage.from('mission-uploads').getPublicUrl(fileName);
                fileUrl = data.publicUrl;
            } catch(error) {
                showToast(`File upload failed: ${error.message}`, true);
                return;
            }
        }

        try {
            const submissionData = { user_id: AppState.currentUser.id, mission_id: missionId, submission_link: link, proof_url: fileUrl };
            const { error } = await supabaseClient.from('submissions').upsert(submissionData, { onConflict: 'user_id, mission_id' });
            if(error) throw error;
            showToast('Mission submitted successfully!');
            closeModal();
            loadInitialData(); // Reload all data
        } catch(error) {
            showToast(`Submission failed: ${error.message}`, true);
        }
    }

    function openFullMissionMap() {
        closeStory();
        // This is a placeholder. A full implementation would switch the main view.
        showToast("Opening full mission map...");
        // Example: switchView('learn', document.querySelector('.nav-button-for-learn'));
    }

    // ======================================================
    // ADMIN PANEL
    // ======================================================
    async function openAdminPanel() {
        if (!AppState.currentUser || AppState.currentUser.role !== 'admin') return;
        openModal('admin');
        const adminContainer = document.getElementById('admin-content-container');
        adminContainer.innerHTML = 'Loading Admin Data...';
        try {
            const { data, error } = await supabaseClient.from('submissions')
                .select(`id, created_at, score, proof_url, submission_link, users(id, name), missions(id, topic, max_points)`)
                .eq('missions.level', AppState.config.level);
            if (error) throw error;
            AppState.allSubmissionsForAdmin = data;
            adminContainer.innerHTML = `
                <div class="admin-sidebar">
                    <button class="admin-tab-button active" onclick="switchAdminView('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</button>
                    <button class="admin-tab-button" onclick="switchAdminView('grading', this)"><i class="fas fa-check-double"></i> Grading</button>
                </div>
                <div class="admin-main-content">
                    <div id="admin-view-dashboard" class="admin-view active"></div>
                    <div id="admin-view-grading" class="admin-view"></div>
                </div>`;
            renderAdminDashboard();
        } catch(err) {
            adminContainer.innerHTML = `<p class="error-display">${err.message}</p>`;
        }
    }

        function switchAdminView(viewId, element) {
        document.querySelectorAll('.admin-tab-button').forEach(btn => btn.classList.remove('active'));
        element.classList.add('active');
        document.querySelectorAll('.admin-view').forEach(v => v.classList.remove('active'));
        const view = document.getElementById(`admin-view-${viewId}`);
        if(view) {
            view.classList.add('active');
            if (viewId === 'dashboard') renderAdminDashboard();
            else if (viewId === 'grading') renderGradingTable();
        }
    }
    
    function renderAdminDashboard() {
        const container = document.getElementById('admin-view-dashboard');
        if (!container) return;
        const pendingCount = AppState.allSubmissionsForAdmin.filter(s => s.score === null).length;
        container.innerHTML = `
            <h4>Dashboard</h4>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="value">${pendingCount}</div>
                    <div class="label">Pending Grade</div>
                </div>
                <div class="stat-card">
                    <div class="value">${AppState.leaderboard.length}</div>
                    <div class="label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="value">${AppState.missions.length}</div>
                    <div class="label">Total Missions</div>
                </div>
            </div>
            <h4>Recent Submissions</h4>
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead><tr><th>Student</th><th>Mission</th><th>Submitted</th><th>Status</th></tr></thead>
                    <tbody>
                        ${AppState.allSubmissionsForAdmin
                            .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))
                            .slice(0, 5)
                            .map(s => `
                            <tr>
                                <td>${s.users.name}</td>
                                <td>${s.missions.topic}</td>
                                <td>${new Date(s.created_at).toLocaleDateString('th-TH')}</td>
                                <td>${s.score === null ? '<span style="color:var(--status-pending);">Pending</span>' : `<span style="color:var(--status-success);">Graded</span>`}</td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    function renderGradingTable() {
        const container = document.getElementById('admin-view-grading');
        if (!container) return;
        const pendingSubmissions = AppState.allSubmissionsForAdmin.filter(s => s.score === null);
        container.innerHTML = `
            <h4>Grade Submissions (${pendingSubmissions.length} pending)</h4>
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead><tr><th>Student</th><th>Mission</th><th>Link/File</th><th>Score</th><th>Action</th></tr></thead>
                    <tbody>
                        ${pendingSubmissions.sort((a,b) => new Date(a.created_at) - new Date(b.created_at)).map(s => `
                            <tr id="sub-row-${s.id}">
                                <td>${s.users.name}</td>
                                <td>${s.missions.topic}</td>
                                <td>
                                    ${s.submission_link ? `<a href="${s.submission_link}" target="_blank" class="link">Link</a>` : ''}
                                    ${s.proof_url ? `<a href="${s.proof_url}" target="_blank" class="link">File</a>` : ''}
                                </td>
                                <td><input type="number" class="score-input" id="score-input-${s.id}" placeholder="/ ${s.missions.max_points}"></td>
                                <td><button class="btn-primary" onclick="handleGradeSubmission(${s.id}, '${s.users.id}')">Save</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
    }
    
    async function handleGradeSubmission(submissionId, userId) {
        const scoreInput = document.getElementById(`score-input-${submissionId}`);
        const score = parseInt(scoreInput.value, 10);
        if (isNaN(score)) { showToast("Please enter a valid number.", true); return; }
        
        scoreInput.disabled = true;
        try {
            // 1. Update the submission score
            const { error: submissionError } = await supabaseClient.from('submissions').update({ score: score }).eq('id', submissionId);
            if(submissionError) throw submissionError;

            // 2. Recalculate the user's total score from scratch for accuracy
            const { data: userSubmissions, error: fetchError } = await supabaseClient.from('submissions').select('score').eq('user_id', userId);
            if(fetchError) throw fetchError;
            
            const newTotalScore = userSubmissions.reduce((sum, sub) => sum + (sub.score || 0), 0);

            // 3. Update the user's total score
            const { error: userError } = await supabaseClient.from('users').update({ total_score: newTotalScore }).eq('id', userId);
            if(userError) throw userError;

            showToast("Score saved successfully!");
            document.getElementById(`sub-row-${submissionId}`)?.remove();
            
            // Refresh main leaderboard data in the background
            loadInitialData();
            
        } catch(error) {
            showToast(`Error saving score: ${error.message}`, true);
            scoreInput.disabled = false;
        }
    }

    // ======================================================
    // UTILITIES
    // ======================================================
    function showError(error) {
        console.error(error);
        const errorMsg = (error && error.message) ? error.message : "An unknown error occurred.";
        document.getElementById('app-container').innerHTML = `<div class="error-display"><h3>Oops!</h3><p>${errorMsg}</p></div>`;
    }
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast-notification ${isError ? 'error' : ''}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300);
        }, 3000);
    }
    
    function openModal(modalName) {
        const modal = document.getElementById(`${modalName}-modal`);
        if (modal) modal.classList.add('visible');
    }
    
    function closeModal() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('visible'));
    }
</script>
</body>
</html>
    
