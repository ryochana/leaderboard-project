<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      :root {
        --bg-color: #3e1a66; --frame-color: #5c3d91; --header-color: #c8389f;
        --gold-color: #ffc700; --silver-color: #c0c0c0; --bronze-color: #cd7f32;
        --item-bg: #f2e8ff; --text-dark: #3e1a66; --text-light: #ffffff;
        --progress-bar-bg: #e0e0e0; --progress-bar-fill: #3498db; --admin-color: #27ae60;
        --danger-color: #c0392b; --status-due: #f1c40f; --status-closed: #e74c3c;
        --status-graded: #2ecc71; --status-pending: #f39c12;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; }
      body {
        font-family: 'Kanit', sans-serif; background-color: var(--bg-color);
        background-image: linear-gradient(180deg, #2c0f4f 0%, #3e1a66 100%);
        color: var(--text-light); display: flex; justify-content: center;
        padding: 10px;
      }
      .main-wrapper { width: 100%; max-width: 95%; }
      @media (min-width: 1024px) { .main-wrapper { max-width: 900px; } }
      .leaderboard-container {
        background-color: var(--frame-color); border: 4px solid var(--gold-color);
        border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.4), inset 0 2px 5px rgba(255,255,255,0.2);
        padding-bottom: 15px; overflow: hidden;
      }
      .header-bar {
        background-color: var(--header-color); padding: 20px; border-bottom: 4px solid var(--gold-color);
        position: relative; display: flex; align-items: center; gap: 20px;
      }
      .header-trophy { font-size: 3.5em; color: var(--gold-color); line-height: 1; flex-shrink: 0; }
      .header-titles { flex-grow: 1; }
      .title-main { font-size: 1.6em; font-weight: 800; line-height: 1.2; }
      .title-sub { font-size: 1em; opacity: 0.9; margin-top: 5px; }
      #user-area { position: absolute; top: 15px; right: 15px; z-index: 20; }
      #user-area-btn {
        background: rgba(0,0,0,0.3); border: none; color: white; cursor: pointer; border-radius: 25px;
        padding: 5px 10px 5px 5px; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s;
      }
      #user-area-btn:hover { background: rgba(0,0,0,0.5); }
      #user-area-pic { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
      #login-text { font-weight: 600; font-size: 0.9em; line-height: 1; }
      .tabs { display: flex; padding: 15px; gap: 10px; flex-wrap: wrap; }
      .tab {
        flex: 1; padding: 12px; text-align: center; background-color: rgba(0,0,0,0.2);
        border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        border: 2px solid transparent; min-width: 100px;
      }
      .tab.active { background-color: var(--text-light); color: var(--text-dark); border-color: var(--gold-color); }
      .content-view { display: none; padding: 0 15px; }
      .content-view.active { display: block; }
      #search-student {
        width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3);
        color: white; padding: 10px 15px; border-radius: 8px; font-family: 'Kanit', sans-serif;
        margin-bottom: 20px; font-size: 1em;
      }
      .student-list { list-style: none; padding: 0; margin: 15px 0; display: grid; gap: 20px; grid-template-columns: 1fr; }
      @media (min-width: 600px) { .student-list { grid-template-columns: repeat(2, 1fr); } }
      @media (min-width: 900px) { .student-list { grid-template-columns: repeat(3, 1fr); } }
      .student-item {
        display: flex; flex-direction: column; background-color: var(--item-bg); color: var(--text-dark);
        border-radius: 15px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); position: relative;
        text-align: center; height: 100%; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;
      }
      .student-item:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
      .rank {
        position: absolute; top: 0; left: 0; background: var(--gold-color); color: var(--text-dark);
        font-weight: 800; font-size: 1.1em; line-height: 1; padding: 6px 12px;
        border-radius: 15px 0 15px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      }
      .student-pic {
        width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
        border: 6px solid var(--frame-color); margin: 20px auto 0 auto; box-shadow: 0 5px 10px rgba(0,0,0,0.2);
      }
      .student-pic.rank-1 { border-color: var(--gold-color); }
      .student-pic.rank-2 { border-color: var(--silver-color); }
      .student-pic.rank-3 { border-color: var(--bronze-color); }
      .student-info { width: 100%; margin-top: 15px; display: flex; flex-direction: column; flex-grow: 1; }
      .student-name { font-weight: 600; font-size: 1.15em; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .student-score { font-size: 1.2em; font-weight: bold; color: var(--header-color); margin-bottom: 10px; }
      .student-score-label { font-size: 0.8em; opacity: 0.7; }
      .progress-container {
        width: 100%; background-color: #e0e0e0; border-radius: 20px; height: 18px;
        position: relative; overflow: hidden; border: 1px solid #ccc; margin-top: auto;
      }
      .progress-bar {
        height: 100%; background-color: #3498db; text-align: center; line-height: 18px;
        color: white; font-weight: 600; font-size: 11px; transition: width 0.5s ease-in-out;
      }
      .badges-container { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 12px; min-height: 30px; }
      .badge-icon { width: 28px; height: 28px; transition: transform 0.2s; }
      .modal-overlay {
        display: none; align-items: center; justify-content: center; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 100;
      }
      .modal-overlay.visible { display: flex; }
      .modal-box {
        background: var(--frame-color); padding: 20px; border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 500px;
        border: 2px solid var(--gold-color); display: flex; flex-direction: column;
        max-height: 85vh; position: relative;
      }
      .detail-modal-header {
        display: flex; align-items: center; gap: 15px; padding-bottom: 15px; margin-bottom: 15px;
        border-bottom: 2px solid rgba(255,255,255,0.2);
      }
      .detail-modal-pic { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid var(--gold-color); flex-shrink: 0; }
      .detail-modal-info h3 { margin: 0; font-size: 1.4em; color: var(--text-light); }
      .detail-modal-info p { margin: 5px 0 0; font-size: 1.1em; color: var(--gold-color); font-weight: 600; }
      .detail-modal-body { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; overflow-y: auto; color: var(--text-light); }
      .detail-modal-close { position: absolute; top: 10px; right: 15px; font-size: 2em; color: var(--text-light); cursor: pointer; transition: transform 0.2s; }
      .detail-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
      .detail-table th { padding: 10px 8px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2); }
      .detail-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
      .status.graded { color: var(--status-graded); font-weight: bold; }
      .mission-list { list-style: none; padding: 0; margin: 15px 0; display: flex; flex-direction: column; gap: 12px; }
      .mission-item {
        background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; display: grid;
        grid-template-columns: 1fr auto; align-items: center; color: var(--text-light);
        gap: 15px;
      }
      .mission-info .mission-topic { font-weight: 600; }
      .mission-info .mission-meta { font-size: 0.85em; opacity: 0.8; margin-top: 5px; }
      #login-modal, #profile-modal { z-index: 200; }
      #login-modal .modal-box, #profile-modal .modal-box { text-align: center; max-width: 400px; }
      .modal-box input, .modal-box select, .admin-form input, .admin-form select {
        width: 100%; background: var(--bg-color); color: var(--text-light); padding: 12px;
        margin-bottom: 15px; border-radius: 10px; border: 1px solid var(--text-light);
        font-family: 'Kanit', sans-serif;
      }
      .modal-box button, .modal-box label, .admin-form button {
        display: block; width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px;
        font-weight: 600; cursor: pointer; border: none; color: white;
        font-family: 'Kanit', sans-serif; font-size: 1em;
      }
      .modal-box .btn-primary, .admin-form .btn-primary, .btn-primary { background: var(--header-color); }
      .modal-box .btn-danger, .btn-danger { background: var(--danger-color); }
      .modal-box .btn-secondary, .btn-secondary { background: #7f8c8d; }
      .modal-error, .modal-message { min-height: 1.2em; font-size: 0.9em; margin-bottom: 10px; }
      .modal-error { color: #ffb8b8; }
      .modal-message { color: var(--gold-color); }
      #profile-preview { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--gold-color); object-fit: cover; margin-bottom: 15px; }
      #image-upload-input { display: none; }
      #profile-name { font-size: 1.5em; font-weight: bold; }
      #profile-score-text { font-size: 1.2em; color: var(--gold-color); }

      /* --- START: ADMIN STYLES --- */
      .tab.admin-tab { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
      .tab.admin-tab.visible { display: block; background-color: var(--admin-color); }
      .admin-section { padding: 20px; background: rgba(0,0,0,0.2); border-radius: 15px; margin-bottom: 25px; }
      .admin-section h3 { margin-top: 0; color: var(--admin-color); border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; }
      .admin-form { display: grid; gap: 10px; }
      .admin-form.grade-form { grid-template-columns: 1fr 1fr; }
      .admin-form .full-width { grid-column: 1 / -1; }
      .admin-form label { margin-bottom: 5px; font-size: 0.9em; text-align: left; }
      #admin-mission-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; }
      .admin-mission-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; }
      .admin-mission-item .btn-delete { background: var(--danger-color); padding: 4px 8px; font-size: 0.8em; margin: 0; width: auto; }
      .btn-primary:hover { background-color: #e04ab1; }
      .btn-danger:hover { background-color: #d64535; }
      .btn-secondary:hover { background-color: #95a5a6; }
      
      .toast-notification {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background-color: var(--admin-color); color: white; padding: 15px 25px;
        border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 1000; font-weight: 600;
        opacity: 0; visibility: hidden; transition: opacity 0.3s, bottom 0.3s;
      }
      .toast-notification.show { opacity: 1; visibility: visible; bottom: 40px; }
      .toast-notification.error { background-color: var(--danger-color); }
      /* --- END: ADMIN STYLES --- */

        #map-view-container {
  width: 100%;
  padding: 30px 15px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏ô‡∏•‡πà‡∏≤‡∏á */
  max-height: 70vh;
  overflow-y: auto;
  /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ */
  background-image: url('https://as1.ftcdn.net/jpg/04/33/56/10/1000_F_433561046_ZukvohmWL49nY8fSDiG70zw3pNbMuRnK.jpg'); /* <-- ‡∏ú‡∏°‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ */
  background-size: cover;
  background-position: top center;
  border-radius: 15px;
}

.mission-row {
  display: flex;
  margin-bottom: 30px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡πà‡∏≤‡∏ô */
  position: relative;
}

/* ‡∏à‡∏±‡∏î‡πÅ‡∏ñ‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡πà‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢, ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏µ‡πà‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
.mission-row:nth-child(even) {
  justify-content: flex-start;
  padding-left: 20%; /* ‡∏ú‡∏•‡∏±‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
}
.mission-row:nth-child(odd) {
  justify-content: flex-end;
  padding-right: 20%; /* ‡∏ú‡∏•‡∏±‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
}

/* ‡∏ï‡∏±‡∏ß "‡∏î‡πà‡∏≤‡∏ô" ‡∏Å‡∏•‡∏°‡πÜ */
.mission-node {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 6px solid #f7d794;
  background-color: #feca57; /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏ó‡∏≠‡∏á = ‡∏ó‡∏≥‡πÑ‡∏î‡πâ */
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 10px;
  box-shadow: 0 6px 12px rgba(0,0,0,0.4);
  transition: transform 0.2s;
  color: #59441d;
}
.mission-node:hover {
  transform: scale(1.1);
}
.mission-node-topic {
  font-weight: 800; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© */
  font-size: 1em;
  line-height: 1.2;
}
.mission-node-points {
  font-size: 0.8em;
  margin-top: 5px;
  font-weight: 600;
  background: rgba(0,0,0,0.1);
  padding: 2px 8px;
  border-radius: 10px;
}

/* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏ü‡∏™ 3) */
.mission-node.locked {
  background-color: #95a5a6;
  border-color: #7f8c8d;
  cursor: not-allowed;
  color: #d1d8e0;
}
.mission-node.completed {
  background-color: #2ecc71;
  border-color: #27ae60;
  color: white;
}
/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô <style> ‡∏Ç‡∏≠‡∏á index.html */

/* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÅ‡∏ñ‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
.mission-row.mission-row-left {
  justify-content: flex-start;
  padding-left: 20%;
}
.mission-row.mission-row-right {
  justify-content: flex-end;
  padding-right: 20%;
}

/* ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô */
.mission-node.urgent-node {
  background-color: #e74c3c; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
  border-color: #c0392b;
  color: white;
  animation: pulse 1.5s infinite; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö! */
}
.mission-node.overdue-node {
  background-color: #525659;
  border-color: #343a40;
  color: #adb5bd;
}

/* Animation ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö */
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
  70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); }
  100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}
        
    </style>
</head>
<body>
    <div id="app-container">
        <div id="initial-loader" style="text-align: center; padding-top: 50px; font-size: 1.2em; color: white;">
          <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>
        <div id="main-content-wrapper" class="main-wrapper" style="display: none;">
             <!-- Content will be built by JavaScript -->
        </div>
    </div>
    
    <div id="modals-container">
    </div>
    <div id="toast-container"></div>

    <script>
      // ======================================================
      // CONFIGURATION
      // ======================================================
      const API_URL = "/.netlify/functions/proxy";

      // ======================================================
      // GLOBAL VARIABLES
      // ======================================================
      let currentUser = null;
      let fullSummaryData = [];
      let filteredSummaryData = [];
      let allMissions = [];
      let missionsLoaded = false;
      let adminData = { students: [], missions: [] };
      
      // ======================================================
      // API & DATA FETCHING
      // ======================================================
      
      // NEW function for GET requests via proxy
      const fetchGet = async (params = {}) => {
        const queryString = new URLSearchParams(params).toString();
        const fullUrl = `${API_URL}?${queryString}`;
        const response = await fetch(fullUrl);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Network response was not ok: ${errorText}`);
        }
        return response.json();
      };
      
      // NEW function for POST requests via proxy
      const postAdminAction = async (action, params) => {
        if (!currentUser) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£");
        
        const payload = { action, ...params, user: currentUser };
        
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!response.ok || (result && result.success === false)) {
           throw new Error(result.error || `Server error: ${response.statusText}`);
        }
        
        return result;
      }

      document.addEventListener('DOMContentLoaded', loadInitialData);

     // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadInitialData() ‡πÄ‡∏î‡∏¥‡∏°

        async function loadInitialData() {
            showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å...");
            try {
                // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                const [summaryResult, missionsResult] = await Promise.all([
                  fetchGet({ action: 'getSummary' }),
                  fetchGet({ action: 'getMissions' })
                ]);
        
                // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ ---
                if (summaryResult.error) throw new Error(`API Error (Summary): ${summaryResult.error}`);
                fullSummaryData = summaryResult.data || [];
                filteredSummaryData = fullSummaryData;
        
                if (missionsResult.error) console.error(`API Error (Missions): ${missionsResult.error}`);
                allMissions = missionsResult.data || [];
                missionsLoaded = true;
                
                // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ---
                buildApp(); 
                await initializeUser();
        
                // --- ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ---
                if (currentUser) {
                  const detailResult = await fetchGet({ action: "getStudentDetail", studentId: currentUser.studentId });
                  if (detailResult && detailResult.data) {
                    currentUserSubmissions = detailResult.data.tasks || [];
                  }
                } else {
                  currentUserSubmissions = []; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á
                }
                
                // Render view ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
                if (document.getElementById('map-view-container')?.classList.contains('active')) {
                    renderMapView();
                }
        
            } catch (error) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‡πÉ‡∏î‡πÜ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô try block, ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ error
                showError(error);
            } finally {
                // ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß, ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏°‡∏∏‡∏ô‡πÜ ‡πÄ‡∏™‡∏°‡∏≠
                showLoader(false);
            }
        }

      async function loadAdminData() {
        if (adminData.students.length > 0) {
            renderAdminView();
            return;
        }
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin...");
        try {
            const [studentsResult, missionsResult] = await Promise.all([
                fetchGet({ action: 'getAllStudents' }),
                fetchGet({ action: 'getAllMissionsForDropdown' })
            ]);

            if (studentsResult.error || missionsResult.error) {
                throw new Error(studentsResult.error || missionsResult.error);
            }
            adminData.students = studentsResult.data || [];
            adminData.missions = missionsResult.data || [];
            renderAdminView();
        } catch (error) {
            document.getElementById('admin-view').innerHTML = `<p style="color:var(--danger-color)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin: ${error.message}</p>`;
        } finally {
            showLoader(false);
        }
      }
      
      // The rest of the JS code remains the same as your original file
      // from buildApp() down to showToast()
      // ... (Paste the rest of your original JavaScript here)

      // ======================================================
      // UI BUILDING AND RENDERING
      // ======================================================
      function buildApp() {
        const mainContent = document.getElementById('main-content-wrapper');
        mainContent.innerHTML = `
            <div class="leaderboard-container">
                <div class="header-bar">
                    <div id="user-area"><button id="user-area-btn"><img id="user-area-pic" src="https://i.ibb.co/6y4jMWT/default-avatar.png" alt="User"><span id="login-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span></button></div>
                    <div class="header-trophy">üèÜ</div>
                    <div class="header-titles"><div class="title-main">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡∏°.3 ‡πÄ‡∏ó‡∏≠‡∏° 1 ‡∏õ‡∏µ 68</div><div class="title-sub">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏ô‡∏ô‡∏ú‡∏±‡∏Å‡∏ä‡∏µ</div></div>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="switchView('leaderboard-view')"><i class="fas fa-trophy"></i> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</div>
                    <div id="mission-tab" class="tab" onclick="switchView('map-view-container')"><i class="fas fa-map-signs"></i> ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
                    <div id="admin-tab" class="tab admin-tab" onclick="switchView('admin-view')"><i class="fas fa-user-shield"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
                </div>
                <div id="leaderboard-view" class="content-view active"><input type="text" id="search-student" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." onkeyup="filterStudentList()"><ul class="student-list" id="student-list-container"></ul></div>
                <div id="map-view-container" class="content-view"></div>
                <div id="admin-view" class="content-view"></div>
            </div>`;
        
        const modalsContainer = document.getElementById('modals-container');
        modalsContainer.innerHTML = `
    <div id="student-detail-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="detail-modal-close" onclick="closeModal('student-detail-modal')">√ó</div>
            <div class="detail-modal-header">
                <img id="detail-modal-pic" src="" class="detail-modal-pic">
                <div class="detail-modal-info">
                    <h3 id="detail-modal-name"></h3>
                    <p id="detail-modal-score"></p>
                </div>
            </div>
            <div id="detail-modal-badges" class="badges-container" style="padding: 0 10px 15px 10px;"></div>
            <div id="detail-modal-body" class="detail-modal-body"></div>
        </div>
    </div>
    
    <div id="login-modal" class="modal-overlay">
        <div class="modal-box">
            <h2>‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</h2>
            <div id="login-error" class="modal-error"></div>
            <input type="text" id="username-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="password" id="password-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn-primary" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn-secondary" onclick="closeModal('login-modal')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
    
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box">
            <h2>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
            <img id="profile-preview" src="">
            <h3 id="profile-name"></h3>
            <p id="profile-score-text"></p>
            <div id="profile-message" class="modal-message"></div>
            <label for="image-upload-input" class="btn-primary">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
            <input type="file" id="image-upload-input" accept="image/png, image/jpeg">
            <button class="btn-danger" onclick="handleLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn-secondary" onclick="closeModal('profile-modal')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="mission-detail-modal" class="modal-overlay">
        <div class="modal-box" style="text-align: left; max-width: 550px;">
            <div class="detail-modal-close" onclick="closeModal('mission-detail-modal')">√ó</div>
            <h2 id="modal-mission-topic" style="margin-top: 0; color: var(--gold-color);"></h2>
            <div id="modal-mission-body">
                <p><strong>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:</strong> <span id="modal-mission-detail"></span></p>
                <p><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:</strong> <span id="modal-mission-dueDate"></span></p>
                <p><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°:</strong> <span id="modal-mission-maxPoints"></span></p>
                <hr style="border-color: rgba(255,255,255,0.2);">
                <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</strong> <span id="modal-mission-user-status"></span></p>
            </div>
            <div id="modal-mission-actions" style="margin-top: 20px;"></div>
        </div>
    </div>
`;

        
        document.getElementById('user-area-btn').addEventListener('click', handleUserAreaClick);
        document.getElementById('image-upload-input').addEventListener('change', handleFileSelect);
        
        renderStudentList();
      }
      
      function renderStudentList() {
        const container = document.getElementById('student-list-container');
        if (!container) return;
        if (!filteredSummaryData || filteredSummaryData.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
          return;
        }
        container.innerHTML = filteredSummaryData.map(student => {
          const rankDisplay = student.rank === 1 ? 'ü•á' : student.rank === 2 ? 'ü•à' : student.rank === 3 ? 'ü•â' : student.rank;
          const profilePic = student.profileUrl || 'https://i.ibb.co/6y4jMWT/default-avatar.png';
          const rankClass = student.rank <= 3 ? `rank-${student.rank}` : '';
          const badgesHtml = (student.earnedBadges || []).map(badge => `<div class="badge-tooltip"><img src="${badge.iconUrl}" alt="${badge.name}" class="badge-icon"><span class="tooltip-text"><b>${badge.name}</b><br>${badge.description}</span></div>`).join('');
          
          return `<li>
                    <div class="student-item" onclick="showStudentDetailModal('${student.studentId}')">
                        <div class="rank">${rankDisplay}</div>
                        <img src="${profilePic}" class="student-pic ${rankClass}" alt="${student.name}">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-score">${student.totalScore} <span class="student-score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span></div>
                            <div class="badges-container">${badgesHtml}</div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${student.progress}%;">${student.progress > 15 ? student.progress + '%' : ''}</div>
                            </div>
                        </div>
                    </div>
                  </li>`;
        }).join('');
      }

      function renderMissionView() {
        const missionsView = document.getElementById('missions-view');
        if (!missionsView) return;
        
        if (!missionsLoaded) {
            missionsView.innerHTML = '<ul class="mission-list"><li><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...</li></ul>';
        } else if (!allMissions || allMissions.length === 0) {
            missionsView.innerHTML = '<ul class="mission-list"><li style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</li></ul>';
        } else {
            missionsView.innerHTML = `<ul class="mission-list">${allMissions.map(mission => 
              `<li class="mission-item">
                 <div class="mission-info">
                   <div class="mission-topic">${mission.topic}</div>
                   <div class="mission-meta">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${mission.dueDate}</div>
                 </div>
                 <div class="mission-actions">
                    <span class="mission-points">${mission.maxPoints} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                 </div>
               </li>`
            ).join('')}</ul>`;
        }
      }

      function renderAdminView() {
        const container = document.getElementById('admin-view');
        const studentOptions = adminData.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        const missionOptions = adminData.missions.map(m => `<option value="${m}">${m}</option>`).join('');

        container.innerHTML = `
            <div class="admin-section">
                <h3><i class="fas fa-clipboard-check"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                <form id="grade-form" class="admin-form grade-form" onsubmit="handleGradeSubmission(event)">
                    <div><label for="student-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="student-select" required>${studentOptions}</select></div>
                    <div><label for="mission-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label><select id="mission-select" required>${missionOptions}</select></div>
                    <div class="full-width"><label for="score-input">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ</label><input type="number" id="score-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" required></div>
                    <button type="submit" class="btn-primary full-width">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                </form>
            </div>
            <div class="admin-section">
                <h3><i class="fas fa-plus-circle"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
                <form id="mission-form" class="admin-form" onsubmit="handleAddMission(event)">
                    <div class="full-width"><label for="mission-topic">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Topic)</label><input type="text" id="mission-topic" required></div>
                    <div class="full-width"><label for="mission-detail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detail)</label><input type="text" id="mission-detail"></div>
                    <div><label for="mission-due">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á (Due Date)</label><input type="date" id="mission-due"></div>
                    <div><label for="mission-points">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° (Max Points)</label><input type="number" id="mission-points" required></div>
                    <button type="submit" class="btn-primary full-width">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
                </form>
                <h4 style="margin-top: 20px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                <ul id="admin-mission-list">
                    ${allMissions.map(m => `<li class="admin-mission-item"><span>${m.topic}</span><button class="btn-delete" onclick="handleDeleteMission('${m.topic}')">‡∏•‡∏ö</button></li>`).join('')}
                </ul>
            </div>
            <div class="admin-section">
                <h3><i class="fas fa-magic"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div id="repair-tool-status">
                    <p>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Submissions</p>
                    <button class="btn-primary" onclick="runAnalysis()"><i class="fas fa-search"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <div id="repair-tool-results" style="display:none;"></div>
            </div>`;
      }
      
      // ======================================================
      // USER MANAGEMENT & UI UPDATES
      // ======================================================
      let currentUserSubmissions = [];

        async function initializeUser() {
            const storedUsername = localStorage.getItem('leaderboardUser');
            if (storedUsername) {
              try {
                const sessionResult = await fetchGet({ action: 'checkUserSession', username: storedUsername });
                currentUser = (sessionResult && sessionResult.user) ? sessionResult.user : null;
                if (!currentUser) localStorage.removeItem('leaderboardUser');
              } catch(err) {
                console.error("Session check failed:", err);
                localStorage.removeItem('leaderboardUser');
                currentUser = null;
              }
            }
            updateUserUI();
        }
      
      function updateUserUI() {
          const userPic = document.getElementById('user-area-pic');
          const loginText = document.getElementById('login-text');
          const adminTab = document.getElementById('admin-tab');

          if(!userPic || !loginText || !adminTab) return;

          const defaultPic = 'https://i.ibb.co/6y4jMWT/default-avatar.png';
          
          if (currentUser) {
              userPic.src = currentUser.profileUrl || defaultPic;
              loginText.style.display = 'none';
              
              const userRecord = fullSummaryData.find(s => String(s.studentId) === String(currentUser.studentId));
              
              document.getElementById('profile-preview').src = userPic.src;
              document.getElementById('profile-name').innerText = currentUser.name;
              document.getElementById('profile-score-text').innerText = userRecord ? `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${userRecord.totalScore}` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
              
              if (currentUser.role === 'admin') {
                  adminTab.classList.add('visible');
              } else {
                  adminTab.classList.remove('visible');
              }
          } else {
              userPic.src = defaultPic;
              loginText.style.display = 'inline';
              adminTab.classList.remove('visible');
          }
      }
      
      async function handleLogin() {
          const username = document.getElementById('username-input').value.trim();
          const password = document.getElementById('password-input').value.trim();
          const errorEl = document.getElementById('login-error');

          if (!username || !password) {
              errorEl.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô";
              return;
          }
          errorEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";

          try {
              // Use fetchGet for userLogin
              const result = await fetchGet({ action: 'userLogin', username: username, password: password });
              if (result.success) {
                  currentUser = result.user;
                  localStorage.setItem('leaderboardUser', currentUser.username);
                  closeModal('login-modal');
                  document.getElementById('username-input').value = '';
                  document.getElementById('password-input').value = '';
                  errorEl.innerText = "";
                  updateUserUI();
                  if (currentUser.role === 'admin' && document.getElementById('admin-view').classList.contains('active')) {
                      loadAdminData();
                  }
              } else {
                  errorEl.innerText = result.error || "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
              }
          } catch (error) {
              console.error("Login failed:", error);
              errorEl.innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
          }
      }
      
      async function handleLogout() {
        localStorage.removeItem('leaderboardUser');
        const oldUserRole = currentUser.role;
        currentUser = null;
        updateUserUI();
        closeModal('profile-modal');
        if (oldUserRole === 'admin' && document.getElementById('admin-view').classList.contains('active')) {
            switchView('leaderboard-view');
        }
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 1 * 1024 * 1024) {
            showToast("‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1MB", true);
            return;
        }

        const reader = new FileReader();
        reader.onloadend = async function() {
            const fileData = reader.result;
            const profileMessage = document.getElementById('profile-message');
            
            profileMessage.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
            showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");

            try {
                const params = {
                    studentId: currentUser.studentId,
                    fileName: file.name,
                    fileData: fileData
                };

                const result = await postAdminAction('uploadProfileImage', params);
                
                if (result.success) {
                    showToast(result.message);
                    profileMessage.innerText = '';
                    
                    document.getElementById('profile-preview').src = result.imageUrl;
                    document.getElementById('user-area-pic').src = result.imageUrl;
                    currentUser.profileUrl = result.imageUrl;
                    
                    const studentInLeaderboard = fullSummaryData.find(s => String(s.studentId) === String(currentUser.studentId));
                    if(studentInLeaderboard) {
                        studentInLeaderboard.profileUrl = result.imageUrl;
                        renderStudentList();
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                profileMessage.innerText = '';
                showToast(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, true);
            } finally {
                showLoader(false);
                event.target.value = ''; 
            }
        };
        reader.readAsDataURL(file);
    }

      // ======================================================
      // ADMIN ACTIONS
      // ======================================================
      async function handleAddMission(event) {
        event.preventDefault();
        const params = {
            topic: document.getElementById('mission-topic').value,
            detail: document.getElementById('mission-detail').value,
            dueDate: document.getElementById('mission-due').value,
            maxPoints: document.getElementById('mission-points').value
        };
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...");
        try {
            const result = await postAdminAction('addMission', params);
            showToast(result.message || result.error, !result.success);
            if (result.success) {
                document.getElementById('mission-form').reset();
                loadInitialData();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
      }

      async function handleDeleteMission(topic) {
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${topic}"?`)) return;
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...");
        try {
            const result = await postAdminAction('deleteMission', { topic: topic });
            showToast(result.message || result.error, !result.success);
            if (result.success) {
                loadInitialData();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
      }

      async function handleGradeSubmission(event) {
        event.preventDefault();
        const params = {
            studentId: document.getElementById('student-select').value,
            missionTopic: document.getElementById('mission-select').value,
            score: document.getElementById('score-input').value
        };
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...");
        try {
            const result = await postAdminAction('gradeSubmission', params);
            showToast(result.message || result.error, !result.success);
            if (result.success) {
                document.getElementById('grade-form').reset();
                loadInitialData();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
      }

      // ======================================================
      // ADMIN REPAIR TOOL FUNCTIONS
      // ======================================================
      async function runAnalysis() {
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï...");
        const statusDiv = document.getElementById('repair-tool-status');
        const resultsDiv = document.getElementById('repair-tool-results');
        try {
            const result = await fetchGet({ action: 'analyzeData' });
            if (result.error) throw new Error(result.error);
            statusDiv.style.display = 'none';
            resultsDiv.style.display = 'block';
            displayAnalysisResults(result.data);
        } catch (error) {
            resultsDiv.innerHTML = `<p class="modal-error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
            resultsDiv.style.display = 'block';
        } finally {
            showLoader(false);
        }
      }

      function displayAnalysisResults(data) {
        const resultsDiv = document.getElementById('repair-tool-results');
        let html = `<p>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î <strong>${data.errorCount}</strong> ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.totalRows} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>`;
        if (data.errorCount > 0) {
            html += `<div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 15px;"><table class="detail-table"><thead><tr><th>‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà</th><th>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î</th></tr></thead><tbody>${data.errors.map(err => `<tr><td style="text-align:center;">${err.rowNumber}</td><td><small>${err.originalData.map(d => d instanceof Date ? d.toLocaleString('sv-SE') : d).join(', ')}</small></td></tr>`).join('')}</tbody></table></div><p style="font-size:0.9em; opacity:0.8;">‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï Backup ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p><button class="btn-danger" onclick="handleRepairData()"><i class="fas fa-exclamation-triangle"></i> ‡πÉ‡∏ä‡πà, ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏° ${data.errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>`;
        } else {
            html += `<p style="color:var(--status-graded);"><strong>‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</strong> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>`;
        }
        html += `<button class="btn-secondary" style="margin-top:10px;" onclick="resetRepairTool()">‡∏Å‡∏•‡∏±‡∏ö</button>`;
        resultsDiv.innerHTML = html;
      }

      function resetRepairTool() {
        document.getElementById('repair-tool-status').style.display = 'block';
        document.getElementById('repair-tool-results').style.display = 'none';
        document.getElementById('repair-tool-results').innerHTML = '';
      }

      async function handleRepairData() {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï Backup ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°")) return;
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Backup ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
        try {
            const result = await fetchGet({ action: 'repairData' });
            showToast(result.message || result.error, !result.success);
            if (result.success && result.backupName) {
                document.getElementById('repair-tool-results').innerHTML = `<p style="color:var(--status-graded);">${result.message}</p><p>‡∏´‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p><button class="btn-primary" onclick="handleUndo()"><i class="fas fa-undo"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (Undo)</button><button class="btn-secondary" style="margin-top:10px;" onclick="resetRepairTool()">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>`;
                loadInitialData();
            } else if (result.success) {
               resetRepairTool();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
      }

      async function handleUndo() {
        if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
        try {
            const result = await fetchGet({ action: 'undoRepair' });
            showToast(result.message || result.error, !result.success);
            if (result.success) {
                resetRepairTool();
                loadInitialData();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
      }
      
      // ======================================================
      // EVENT HANDLERS & UTILITIES
      // ======================================================

        // ‡πÉ‡∏ô index.html

                                    function renderMapView() {
                          const container = document.getElementById('map-view-container');
                          if (!container) return;
                          if (!missionsLoaded) {
                              container.innerHTML = '<div style="text-align:center; padding: 50px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>';
                              return;
                          }
                          
                          const submissionMap = new Map(
                            currentUserSubmissions.map(task => [task.task, task])
                          );
                        
                          // --- ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡πÉ‡∏´‡∏°‡πà ---
                          const sortedMissions = [...allMissions].sort((a, b) => { // ‡∏™‡∏£‡πâ‡∏≤‡∏á copy ‡∏Ç‡∏≠‡∏á array ‡∏Å‡πà‡∏≠‡∏ô sort
                            const aIsCompleted = submissionMap.has(a.topic);
                            const bIsCompleted = submissionMap.has(b.topic);
                            const aIsActive = a.timingStatus === 'active';
                            const bIsActive = b.timingStatus === 'active';
                            const aIsUpcoming = a.timingStatus === 'upcoming';
                            const bIsUpcoming = b.timingStatus === 'upcoming';
                            
                            // 1. ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà Active ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î
                            if (aIsActive && !aIsCompleted && (!bIsActive || bIsCompleted)) return -1;
                            if (bIsActive && !bIsCompleted && (!aIsActive || aIsCompleted)) return 1;
                            
                            // -- ‡∏ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà Active ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô --
                            if (aIsActive && !aIsCompleted && bIsActive && !bIsCompleted) {
                                if (a.urgency === 'urgent' && b.urgency !== 'urgent') return -1;
                                if (b.urgency === 'urgent' && a.urgency !== 'urgent') return 1;
                                return a.dueDate - b.dueDate;
                            }
                        
                            // 2. ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -> ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
                            if (aIsCompleted && !bIsCompleted) return 1;
                            if (bIsCompleted && !aIsCompleted) return -1;
                            if (aIsCompleted && bIsCompleted) {
                               // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (dueDate ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î) ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô
                               return b.dueDate - a.dueDate;
                            }
                        
                            // 3. ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Upcoming) -> ‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
                            if (aIsUpcoming && !bIsUpcoming) return 1;
                            if (bIsUpcoming && !aIsUpcoming) return -1;
                            if (aIsUpcoming && bIsUpcoming) {
                              // ‡∏≠‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡∏Å‡πá‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô (‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô)
                              return a.assignedDate - b.assignedDate;
                            }
                        
                            // 4. ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (Past ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á) -> ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                            return b.dueDate - a.dueDate;
                          });
                          
                          // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ---
                          let missionHtml = '';
                          sortedMissions.forEach((mission, index) => { // <--- ‡πÉ‡∏ä‡πâ sortedMissions ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
                            let status = '';
                            let icon = 'üîí';
                        
                            const sub = submissionMap.get(mission.topic);
                            const isSubmitted = !!sub;
                        
                            if (mission.timingStatus === 'active') {
                                if (isSubmitted) {
                                    status = 'completed' + (sub.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à' ? ' pending' : '');
                                    icon = (sub.status === '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß') ? `‚úîÔ∏è ${sub.score}` : '‚åõ';
                                } else { // Active ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á
                                    status = 'available';
                                    if (mission.urgency === 'urgent') status += ' urgent-node';
                                    icon = `<b>${mission.maxPoints}</b><small>pt</small>`;
                                }
                            } else if (isSubmitted) { // Past ‡∏´‡∏£‡∏∑‡∏≠ Upcoming ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                                status = 'completed';
                                icon = `‚úîÔ∏è ${sub.score}`;
                            } else { // Past ‡∏´‡∏£‡∏∑‡∏≠ Upcoming ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á
                                status = 'locked';
                                if (mission.timingStatus === 'past') {
                                    status += ' overdue-node'; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°
                                }
                            }
                            
                            const rowClass = (index % 2 === 0) ? 'mission-row-left' : 'mission-row-right';
                            
                            missionHtml += `
                              <div class="mission-row ${rowClass}">
                                <div class="mission-node ${status}" onclick="showMissionDetail('${mission.topic}')" title="${mission.topic}">
                                  <div class="mission-node-topic">${mission.topic}</div>
                                  <div class="mission-node-points">${icon}</div> 
                                </div>
                              </div>
                            `;
                          });
                          
                          container.innerHTML = missionHtml || '<div style="text-align:center; padding: 50px; color: #fff;">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
                        }
            
            function showMissionDetail(topic) {
                const mission = allMissions.find(m => m.topic === topic);
                if (!mission) return;
                const submission = currentUserSubmissions.find(s => s.task === topic);
            
                // --- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ---
                document.getElementById('modal-mission-topic').innerText = mission.topic;
                // ... (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á detail, maxPoints ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                document.getElementById('modal-mission-dueDate').innerHTML = `‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${mission.dueDateString}`;
                
                // --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ---
                const userStatusEl = document.getElementById('modal-mission-user-status');
                const actionsContainer = document.getElementById('modal-mission-actions');
                let actionsHtml = `<button class="btn-secondary" onclick="closeModal('mission-detail-modal')">‡∏õ‡∏¥‡∏î</button>`;
                
                if (submission) {
                    // ... (‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                } else { // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á
                    if (mission.timingStatus === 'active') {
                        userStatusEl.innerHTML = `<span style="font-weight: bold; color: var(--gold-color);">‡∏£‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</span>`;
                        actionsHtml = `<button class="btn-primary" onclick="alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô')">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>` + actionsHtml;
                    } else if (mission.timingStatus === 'upcoming') {
                        userStatusEl.innerHTML = `<span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${mission.assignedDateString})</span>`;
                    } else { // past
                        userStatusEl.innerHTML = `<span style="color: #e74c3c;">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</span>`;
                    }
                }
            
                actionsContainer.innerHTML = actionsHtml;
                openModal('mission-detail-modal');
            }
            
                  function filterStudentList() {
                    const searchTerm = document.getElementById('search-student').value.toLowerCase();
                    filteredSummaryData = searchTerm ? fullSummaryData.filter(s => s.name.toLowerCase().includes(searchTerm)) : [...fullSummaryData];
                    renderStudentList();
                  }
            
                  function handleUserAreaClick(){ currentUser ? openModal("profile-modal") : openModal("login-modal"); }
                  function openModal(id){ document.getElementById(id)?.classList.add("visible"); }
                  function closeModal(id){ document.getElementById(id)?.classList.remove("visible"); }
            
                  async function showStudentDetailModal(studentId) {
                      const student = fullSummaryData.find(s => String(s.studentId) === String(studentId));
                      if (!student) return;
            
                      document.getElementById('detail-modal-pic').src = student.profileUrl || 'https://i.ibb.co/6y4jMWT/default-avatar.png';
                      document.getElementById('detail-modal-name').innerText = student.name;
                      document.getElementById('detail-modal-score').innerText = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${student.totalScore}`;
                      document.getElementById('detail-modal-badges').innerHTML = (student.earnedBadges || []).map(b => `<div class="badge-tooltip"><img src="${b.iconUrl}" alt="${b.name}" class="badge-icon"><span class="tooltip-text"><b>${b.name}</b><br>${b.description}</span></div>`).join('');
                      
                      const body = document.getElementById('detail-modal-body');
                      body.innerHTML = '<div style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</div>';
                      openModal('student-detail-modal');
                      
                      try {
                          const result = await fetchGet({ action: "getStudentDetail", studentId: studentId });
                          if (result.error) throw new Error(result.error);
                          displayDetailsInModal(result.data);
                      } catch(err) {
                          body.innerHTML = `<p style="color: var(--danger-color); text-align: center;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</p>`;
                      }
                  }

                function switchView(viewId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabElement = document.querySelector(`.tab[onclick="switchView('${viewId}')"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
        
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            const viewElement = document.getElementById(viewId);
            if (viewElement) {
                viewElement.classList.add('active');
            }
        
            if (viewId === 'map-view-container') {
                renderMapView();
            } 
            else if (viewId === 'admin-view') {
                loadAdminData();
            }
        }

      function displayDetailsInModal(data) {
        if (!data || !data.tasks) {
            document.getElementById('detail-modal-body').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>';
            return;
        }
        document.getElementById('detail-modal-score').innerText = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${data.summary.totalScore}`;
        let tableHtml = `<table class="detail-table"><thead><tr><th>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</th><th style="text-align:center;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th style="text-align:right;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead><tbody>`;
        data.tasks.forEach(item => {
          let statusClass = '', statusText = '';
          switch(item.status) {
              case '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß': statusClass = 'graded'; statusText = `<i class="fas fa-check-circle"></i> ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß`; break;
              case '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à': statusClass = 'pending'; statusText = `‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à`; break;
              default: statusClass = 'not-submitted'; statusText = '‚úó ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á';
          }
          tableHtml += `<tr><td>${item.task}</td><td class="status ${statusClass}" align="center">${statusText}</td><td align="right">${item.score} / ${item.maxPoints}</td></tr>`;
        });
        tableHtml += '</tbody></table>';
        document.getElementById('detail-modal-body').innerHTML = tableHtml;
      }
      
      function showLoader(show, text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
        const loader = document.getElementById('initial-loader');
        const mainContent = document.getElementById('main-content-wrapper');
        if (show) {
          if(loader) loader.style.display = 'block';
          if(loader) loader.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
          if(mainContent) mainContent.style.display = 'none';
        } else {
          if(loader) loader.style.display = 'none';
          if(mainContent) mainContent.style.display = 'block';
        }
      }

      function showError(error) {
        console.error(error);
        const errorMsg = (error && error.message) ? error.message : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏";
        const appContainer = document.getElementById('app-container');
        if (appContainer) {
          appContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #ffb8b8; background: rgba(0,0,0,0.3); border-radius: 10px;"><h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p>${errorMsg}</p></div>`;
        }
      }

      function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        if (isError) {
            toast.classList.add('error');
        }
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300);
        }, 4000);
      }
    </script>
</body>
</html>
