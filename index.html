<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENG M3 NPC 68</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Your new stylesheet link -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- App Container ‡∏´‡∏•‡∏±‡∏Å -->
    <div id="app-container">
        <div id="initial-loader" style="text-align: center; padding-top: 50px; font-size: 1.2em; color: white;">
          <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>
        <div id="main-content-wrapper" class="main-wrapper" style="display: none;">
             <!-- Content ‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JS ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </div>
    </div>
    
    <!-- Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modals ‡πÅ‡∏•‡∏∞ Toast ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JS -->
    <div id="modals-container"></div>
    <div id="toast-container"></div>

    <script>
    // ======================================================
    // CONFIGURATION
    // ======================================================
    const API_URL = "/.netlify/functions/proxy";

    // ======================================================
    // GLOBAL VARIABLES
    // ======================================================
    let currentUser = null;
    let fullSummaryData = [];
    let filteredSummaryData = [];
    let allMissions = [];
    let missionsLoaded = false;
    let adminData = { students: [], missions: [] };
    let currentUserSubmissions = [];
    let currentMissionTopic = null;

    // ======================================================
    // INITIALIZATION
    // ======================================================
    window.addEventListener('load', initializeApp);

    function getGradeConfigFromUrl() {
        const hostname = window.location.hostname;
        if (hostname.includes('eng-m1')) {
            return { level: 'M1', title: '‡∏°.1' };
        }
        if (hostname.includes('eng-m2')) {
            return { level: 'M2', title: '‡∏°.2' };
        }
        return { level: 'M3', title: '‡∏°.3' };
    }

    async function initializeApp() {
         document.title = `ENG ${getGradeConfigFromUrl().title} NPC 68`;
        buildApp();
        await initializeUser();
        loadInitialData();
    }

    // ======================================================
    // API & DATA FETCHING
    // ======================================================
    const fetchGet = async (params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    const fullUrl = `${API_URL}?${queryString}`;
    
    const response = await fetch(fullUrl);
    const text = await response.text(); // ‡∏≠‡πà‡∏≤‡∏ô response ‡πÄ‡∏õ‡πá‡∏ô text ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠

    if (!response.ok) {
        // ‡∏ñ‡πâ‡∏≤ server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡πÇ‡∏¢‡∏ô error ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å server
        throw new Error(`Network response was not ok: ${text}`);
    }

    try {
        // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse ‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡πà‡∏≠‡∏ô
        return JSON.parse(text); 
    } catch (e) {
        // ‡∏ñ‡πâ‡∏≤ parse ‡πÅ‡∏ö‡∏ö JSON ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô JSONP)
        // ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å JSONP
        const jsonpMatch = text.match(/^[a-zA-Z0-9_]+\(([\s\S]*)\)$/);
        if (jsonpMatch && jsonpMatch[1]) {
            try {
                // ‡∏•‡∏≠‡∏á parse ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö
                return JSON.parse(jsonpMatch[1]);
            } catch (jsonpError) {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ
                throw new Error(`Failed to parse JSONP content: ${jsonpError.message}`);
            }
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ó‡∏±‡πâ‡∏á JSON ‡πÅ‡∏•‡∏∞ JSONP ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ response ‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
            throw new Error("Received non-JSON, non-JSONP response from server.");
        }
    }
};

    const postAdminAction = async (action, params) => {
        if (!currentUser) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£");

        const payload = { action, ...params, user: currentUser };

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!response.ok || (result && result.success === false)) {
            throw new Error(result.error || `Server error: ${response.statusText}`);
        }

        return result;
    }

    async function loadInitialData() {
        const listContainer = document.getElementById('student-list-container');
        if (listContainer) listContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö...</div>';
        
        try {
            const [summaryResult, missionsResult] = await Promise.all([
                fetchGet({ action: 'getSummary' }),
                fetchGet({ action: 'getMissions' })
            ]);

            if (summaryResult.error) throw new Error(`API Error (Summary): ${summaryResult.error}`);
            fullSummaryData = summaryResult.data || [];
            filteredSummaryData = fullSummaryData;

            if (missionsResult.error) console.error(`API Error (Missions): ${missionsResult.error}`);
            allMissions = missionsResult.data || [];
            missionsLoaded = true;

            renderStudentList();
            updateUserUI();

            if (currentUser) {
                const detailResult = await fetchGet({ action: "getStudentDetail", studentId: currentUser.studentId });
                if (detailResult && detailResult.data) {
                    currentUserSubmissions = detailResult.data.tasks || [];
                }
            } else {
                currentUserSubmissions = [];
            }

            if (document.getElementById('map-view-container')?.classList.contains('active')) {
                renderMapView();
            }

        } catch (error) {
            showError(error);
        } finally {
            document.getElementById('initial-loader').style.display = 'none';
            document.getElementById('main-content-wrapper').style.display = 'block';
        }
    }

    async function loadAdminData() {
        if (adminData.students.length > 0) {
            renderAdminView();
            return;
        }
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin...");
        try {
            const [studentsResult, missionsResult] = await Promise.all([
                fetchGet({ action: 'getAllStudents' }),
                fetchGet({ action: 'getAllMissionsForDropdown' })
            ]);

            if (studentsResult.error || missionsResult.error) {
                throw new Error(studentsResult.error || missionsResult.error);
            }
            adminData.students = studentsResult.data || [];
            adminData.missions = missionsResult.data || [];
            renderAdminView();
        } catch (error) {
            document.getElementById('admin-view').innerHTML = `<p style="color:var(--danger-color)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
        } finally {
            showLoader(false);
        }
    }

    // ======================================================
    // UI BUILDING AND RENDERING
    // ======================================================
    function buildApp() {
    const mainContent = document.getElementById('main-content-wrapper');
    const config = getGradeConfigFromUrl(); // <-- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏à‡∏≤‡∏Å URL (‡πÄ‡∏ä‡πà‡∏ô { title: '‡∏°.1' })

    // *** ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ***
    // Template string ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ config.title ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    mainContent.innerHTML = `
        <div class="leaderboard-container">
            <div class="header-bar">
                <div id="user-area"><button id="user-area-btn"><img id="user-area-pic" src="https://i.ibb.co/6BH4M3n/default-avatar.png" alt="User"><span id="login-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span></button></div>
                <div class="header-trophy">üèÜ</div>
                <div class="header-titles">
                    <div class="title-main">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ${config.title} ‡πÄ‡∏ó‡∏≠‡∏° 1 ‡∏õ‡∏µ 68</div>
                    <div class="title-sub">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏ô‡∏ô‡∏ú‡∏±‡∏Å‡∏ä‡∏µ</div>
                </div>
            </div>
            <div class="tabs">
                <div class="tab active" onclick="switchView('leaderboard-view')"><i class="fas fa-trophy"></i> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</div>
                <div id="mission-tab" class="tab" onclick="switchView('map-view-container')"><i class="fas fa-map-signs"></i> ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
                <div id="admin-tab" class="tab admin-tab" onclick="switchView('admin-view')"><i class="fas fa-user-shield"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
            </div>
            <div id="leaderboard-view" class="content-view active"><input type="text" id="search-student" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." onkeyup="filterStudentList()"><ul class="student-list" id="student-list-container"></ul></div>
            <div id="map-view-container" class="content-view"></div>
            <div id="admin-view" class="content-view"></div>
        </div>`;

        const modalsContainer = document.getElementById('modals-container');
        modalsContainer.innerHTML = `
            <div id="student-detail-modal" class="modal-overlay">
                <div class="modal-box">
                    <div class="detail-modal-close" onclick="closeModal('student-detail-modal')">√ó</div>
                    <div class="detail-modal-header">
                        <img id="detail-modal-pic" src="" class="detail-modal-pic">
                        <div class="detail-modal-info">
                            <h3 id="detail-modal-name"></h3>
                            <p id="detail-modal-score"></p>
                        </div>
                    </div>
                    <div id="detail-modal-badges" class="badges-container" style="padding: 0 10px 15px 10px;"></div>
                    <div id="detail-modal-body" class="detail-modal-body"></div>
                </div>
            </div>
            <div id="login-modal" class="modal-overlay">
                <div class="modal-box">
                    <h2>‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</h2>
                    <div id="login-error" class="modal-error"></div>
                    <input type="text" id="username-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
                    <input type="password" id="password-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    <button class="btn-primary" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button class="btn-secondary" onclick="closeModal('login-modal')">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            <div id="profile-modal" class="modal-overlay">
                <div class="modal-box">
                    <h2>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
                    <img id="profile-preview" src="">
                    <h3 id="profile-name"></h3>
                    <p id="profile-score-text"></p>
                    <div id="profile-message" class="modal-message"></div>
                    <label for="image-upload-input" class="btn-primary">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                    <input type="file" id="image-upload-input" accept="image/png, image/jpeg">
                    <button class="btn-danger" onclick="handleLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button class="btn-secondary" onclick="closeModal('profile-modal')">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            <div id="mission-detail-modal" class="modal-overlay">
                <div class="modal-box" style="text-align: left; max-width: 550px;">
                    <div class="detail-modal-close" onclick="closeModal('mission-detail-modal')">√ó</div>
                    <h2 id="modal-mission-topic" style="margin-top: 0; color: var(--gold-color);"></h2>
                    <div id="modal-mission-body">
                        <p><strong>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:</strong> <span id="modal-mission-detail"></span></p>
                        <p><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:</strong> <span id="modal-mission-dueDate"></span></p>
                        <p><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°:</strong> <span id="modal-mission-maxPoints"></span></p>
                        <hr style="border-color: rgba(255,255,255,0.2);">
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</strong> <span id="modal-mission-user-status"></span></p>
                    </div>
                    <div id="modal-mission-actions" style="margin-top: 20px;"></div>
                </div>
            </div>
            <div id="submission-modal" class="modal-overlay">
                <div class="modal-box">
                    <div class="detail-modal-close" onclick="closeModal('submission-modal')">√ó</div>
                    <h2 style="margin-top:0;">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: <span id="submission-modal-topic"></span></h2>
                    <div id="submission-form-area">
                        <p style="font-size: 0.9em; opacity: 0.8; margin-top: -10px; margin-bottom: 20px;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á)</p>
                        <label for="submission-link">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <input type="url" id="submission-link" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://www.canva.com/design/...">
                        <label for="submission-file">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <input type="file" id="submission-file">
                        <small id="file-upload-status" style="margin-top: -10px; display: block; min-height: 1.2em;"></small>
                        <div id="submission-error" class="modal-error"></div>
                    </div>
                    <div id="submission-loader" style="display:none; text-align:center; padding: 40px 0;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p id="submission-loader-text" style="margin-top: 15px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...</p>
                    </div>
                    <div id="submission-buttons">
                        <button class="btn-primary" onclick="handleSubmitMission()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
                        <button class="btn-secondary" onclick="closeModal('submission-modal')">‡∏õ‡∏¥‡∏î</button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('user-area-btn').addEventListener('click', handleUserAreaClick);
        document.getElementById('image-upload-input').addEventListener('change', handleFileSelect);
        
        // renderStudentList(); // This is called in loadInitialData now
    }

    function renderStudentList() {
        const container = document.getElementById('student-list-container');
        if (!container) return;
        if (!filteredSummaryData || filteredSummaryData.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
            return;
        }
        container.innerHTML = filteredSummaryData.map(student => {
            const rankDisplay = student.rank === 1 ? 'ü•á' : student.rank === 2 ? 'ü•à' : student.rank === 3 ? 'ü•â' : student.rank;
             let profilePic = student.profileUrl || 'https://i.ibb.co/6BH4M3n/default-avatar.png';
        if (student.profileUrl) {
            profilePic = `${student.profileUrl}?t=${new Date().getTime()}`;
        }
            const rankClass = student.rank <= 3 ? `rank-${student.rank}` : '';
            const badgesHtml = (student.earnedBadges || []).map(badge => `<div class="badge-tooltip"><img src="${badge.iconUrl}" alt="${badge.name}" class="badge-icon"><span class="tooltip-text"><b>${badge.name}</b><br>${badge.description}</span></div>`).join('');

            return `<li>
                        <div class="student-item" onclick="showStudentDetailModal('${student.studentId}')">
                            <div class="rank">${rankDisplay}</div>
                            <img src="${profilePic}" class="student-pic ${rankClass}" alt="${student.name}">
                            <div class="student-info">
                                <div class="student-name">${student.name}</div>
                                <div class="student-score">${student.totalScore} <span class="student-score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span></div>
                                <div class="badges-container">${badgesHtml}</div>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${student.progress}%;">${student.progress > 15 ? student.progress + '%' : ''}</div>
                                </div>
                            </div>
                        </div>
                      </li>`;
        }).join('');
    }

    function renderAdminView() {
        const container = document.getElementById('admin-view');
        if (!adminData || !adminData.students || !adminData.missions) {
            container.innerHTML = "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin...</p>";
            return;
        }
        const studentOptions = adminData.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        const missionOptions = adminData.missions.map(m => `<option value="${m}">${m}</option>`).join('');

        container.innerHTML = `
            <div class="admin-section">
                <h3><i class="fas fa-clipboard-check"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                <form id="grade-form" class="admin-form grade-form" onsubmit="handleGradeSubmission(event)">
                    <div><label for="student-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="student-select" required>${studentOptions}</select></div>
                    <div><label for="mission-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label><select id="mission-select" required>${missionOptions}</select></div>
                    <div class="full-width"><label for="score-input">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ</label><input type="number" id="score-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" required></div>
                    <button type="submit" class="btn-primary full-width">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                </form>
            </div>
            <div class="admin-section">
                <h3><i class="fas fa-plus-circle"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
                <form id="mission-form" class="admin-form" onsubmit="handleAddMission(event)">
                    <div class="full-width"><label for="mission-topic">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Topic)</label><input type="text" id="mission-topic" required></div>
                    <div class="full-width"><label for="mission-detail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detail)</label><input type="text" id="mission-detail"></div>
                    <div><label for="mission-due">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á (Due Date)</label><input type="date" id="mission-due"></div>
                    <div><label for="mission-points">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° (Max Points)</label><input type="number" id="mission-points" required></div>
                    <button type="submit" class="btn-primary full-width">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
                </form>
                <h4 style="margin-top: 20px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                <ul id="admin-mission-list">
                    ${allMissions.map(m => `<li class="admin-mission-item"><span>${m.topic}</span><button class="btn-delete" onclick="handleDeleteMission('${m.topic}')">‡∏•‡∏ö</button></li>`).join('')}
                </ul>
            </div>
            <div class="admin-section">
                <h3><i class="fas fa-magic"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div id="repair-tool-status">
                    <p>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Submissions</p>
                    <button class="btn-primary" onclick="runAnalysis()"><i class="fas fa-search"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <div id="repair-tool-results" style="display:none;"></div>
            </div>`;
    }

    // ======================================================
    // USER MANAGEMENT & UI UPDATES
    // ======================================================
    async function initializeUser() {
        const storedUsername = localStorage.getItem('leaderboardUser');
        if (storedUsername) {
            try {
                const sessionResult = await fetchGet({ action: 'checkUserSession', username: storedUsername });
                currentUser = (sessionResult && sessionResult.user) ? sessionResult.user : null;
                if (!currentUser) localStorage.removeItem('leaderboardUser');
            } catch (err) {
                console.error("Session check failed:", err);
                localStorage.removeItem('leaderboardUser');
                currentUser = null;
            }
        }
        updateUserUI();
    }

    function updateUserUI() {
        const userPic = document.getElementById('user-area-pic');
        const loginText = document.getElementById('login-text');
        const adminTab = document.getElementById('admin-tab');

        if (!userPic || !loginText || !adminTab) return;

        const defaultPic = 'https://i.ibb.co/RkgFJztg/AVATAR.jpg';

        
        if (currentUser) {
            let profileUrl = currentUser.profileUrl || defaultPic;
        if (currentUser.profileUrl) {
            profileUrl = `${currentUser.profileUrl}?t=${new Date().getTime()}`;
        }
        userPicEl.src = profileUrl;
        document.getElementById('profile-preview').src = profileUrl;
            loginText.style.display = 'none';

            const userRecord = fullSummaryData.find(s => String(s.studentId) === String(currentUser.studentId));

            document.getElementById('profile-preview').src = userPic.src;
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-score-text').innerText = userRecord ? `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${userRecord.totalScore}` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';

            if (currentUser.role === 'admin') {
                adminTab.classList.add('visible');
            } else {
                adminTab.classList.remove('visible');
            }
        } else {
            userPic.src = defaultPic;
            loginText.style.display = 'inline';
            adminTab.classList.remove('visible');
        }
    }

    async function handleLogin() {
        const username = document.getElementById('username-input').value.trim();
        const password = document.getElementById('password-input').value.trim();
        const errorEl = document.getElementById('login-error');

        if (!username || !password) {
            errorEl.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô";
            return;
        }
        errorEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";

        try {
            const result = await fetchGet({ action: 'userLogin', username: username, password: password });
            if (result.success) {
                currentUser = result.user;
                localStorage.setItem('leaderboardUser', currentUser.username);
                closeModal('login-modal');
                document.getElementById('username-input').value = '';
                document.getElementById('password-input').value = '';
                errorEl.innerText = "";
                await loadInitialData();
            } else {
                errorEl.innerText = result.error || "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
            }
        } catch (error) {
            console.error("Login failed:", error);
            errorEl.innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
        }
    }

    async function handleLogout() {
        localStorage.removeItem('leaderboardUser');
        currentUser = null;
        currentUserSubmissions = [];
        closeModal('profile-modal');
        await loadInitialData();
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 1 * 1024 * 1024) { // 1MB size limit
            showToast("‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1MB", true);
            return;
        }

        const reader = new FileReader();
        reader.onloadend = async function () {
            const fileData = reader.result;
            const profileMessage = document.getElementById('profile-message');

            profileMessage.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
            showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");

            try {
                const params = {
                    studentId: currentUser.studentId,
                    fileData: fileData
                };
                const result = await postAdminAction('uploadProfileImage', params);
                if (result.success) {
                    showToast(result.message);
                    profileMessage.innerText = '';
                    document.getElementById('profile-preview').src = result.imageUrl;
                    document.getElementById('user-area-pic').src = result.imageUrl;
                    currentUser.profileUrl = result.imageUrl;
                    const studentInLeaderboard = fullSummaryData.find(s => String(s.studentId) === String(currentUser.studentId));
                    if (studentInLeaderboard) {
                        studentInLeaderboard.profileUrl = result.imageUrl;
                        renderStudentList();
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                profileMessage.innerText = '';
                showToast(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, true);
            } finally {
                showLoader(false);
                event.target.value = '';
            }
        };
        reader.readAsDataURL(file);
    }

    // ======================================================
    // ADMIN ACTIONS
    // ======================================================
    async function handleAddMission(event) {
        event.preventDefault();
        const params = {
            topic: document.getElementById('mission-topic').value,
            detail: document.getElementById('mission-detail').value,
            dueDate: document.getElementById('mission-due').value,
            maxPoints: document.getElementById('mission-points').value
        };
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...");
        try {
            const result = await postAdminAction('addMission', params);
            showToast(result.message || result.error, !result.success);
            if (result.success) {
                document.getElementById('mission-form').reset();
                await loadInitialData();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
    }

    async function handleDeleteMission(topic) {
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${topic}"?`)) return;
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...");
        try {
            const result = await postAdminAction('deleteMission', { topic: topic });
            showToast(result.message || result.error, !result.success);
            if (result.success) {
                await loadInitialData();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
    }

    async function handleGradeSubmission(event) {
        event.preventDefault();
        const params = {
            studentId: document.getElementById('student-select').value,
            missionTopic: document.getElementById('mission-select').value,
            score: document.getElementById('score-input').value
        };
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...");
        try {
            const result = await postAdminAction('gradeSubmission', params);
            showToast(result.message || result.error, !result.success);
            if (result.success) {
                document.getElementById('grade-form').reset();
                await loadInitialData();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
    }

    // ======================================================
    // ADMIN REPAIR TOOL FUNCTIONS
    // ======================================================
    async function runAnalysis() {
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï...");
        const statusDiv = document.getElementById('repair-tool-status');
        const resultsDiv = document.getElementById('repair-tool-results');
        try {
            const result = await fetchGet({ action: 'analyzeData' });
            if (result.error) throw new Error(result.error);
            statusDiv.style.display = 'none';
            resultsDiv.style.display = 'block';
            displayAnalysisResults(result.data);
        } catch (error) {
            resultsDiv.innerHTML = `<p class="modal-error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
            resultsDiv.style.display = 'block';
        } finally {
            showLoader(false);
        }
    }

    function displayAnalysisResults(data) {
        const resultsDiv = document.getElementById('repair-tool-results');
        let html = `<p>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î <strong>${data.errorCount}</strong> ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.totalRows} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>`;
        if (data.errorCount > 0) {
            html += `<div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 15px;"><table class="detail-table"><thead><tr><th>‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà</th><th>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î</th></tr></thead><tbody>${data.errors.map(err => `<tr><td style="text-align:center;">${err.rowNumber}</td><td><small>${err.originalData.map(d => d instanceof Date ? d.toLocaleString('sv-SE') : d).join(', ')}</small></td></tr>`).join('')}</tbody></table></div><p style="font-size:0.9em; opacity:0.8;">‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï Backup ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p><button class="btn-danger" onclick="handleRepairData()"><i class="fas fa-exclamation-triangle"></i> ‡πÉ‡∏ä‡πà, ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏° ${data.errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>`;
        } else {
            html += `<p style="color:var(--status-graded);"><strong>‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</strong> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>`;
        }
        html += `<button class="btn-secondary" style="margin-top:10px;" onclick="resetRepairTool()">‡∏Å‡∏•‡∏±‡∏ö</button>`;
        resultsDiv.innerHTML = html;
    }

    function resetRepairTool() {
        document.getElementById('repair-tool-status').style.display = 'block';
        document.getElementById('repair-tool-results').style.display = 'none';
        document.getElementById('repair-tool-results').innerHTML = '';
    }

    async function handleRepairData() {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï Backup ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°")) return;
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Backup ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
        try {
            const result = await fetchGet({ action: 'repairData' });
            showToast(result.message || result.error, !result.success);
            if (result.success && result.backupName) {
                document.getElementById('repair-tool-results').innerHTML = `<p style="color:var(--status-graded);">${result.message}</p><p>‡∏´‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p><button class="btn-primary" onclick="handleUndo()"><i class="fas fa-undo"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (Undo)</button><button class="btn-secondary" style="margin-top:10px;" onclick="resetRepairTool()">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>`;
                await loadInitialData();
            } else if (result.success) {
                resetRepairTool();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
    }

    async function handleUndo() {
        if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
        showLoader(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
        try {
            const result = await fetchGet({ action: 'undoRepair' });
            showToast(result.message || result.error, !result.success);
            if (result.success) {
                resetRepairTool();
                await loadInitialData();
            }
        } catch (error) { showToast(error.message, true); }
        finally { showLoader(false); }
    }

    // ======================================================
    // EVENT HANDLERS & UTILITIES
    // ======================================================
    function renderMapView() {
    const container = document.getElementById('map-view-container');
    if (!container) return;
    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---
    if (!currentUser) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ng∆∞·ªùi d√πng ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà
        container.innerHTML = `
            <div class="login-overlay-wrapper">
                <div class="login-overlay-content">
                    <i class="fas fa-lock"></i>
                    <h3>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô</h3>
                    <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    <button class="btn-primary" onclick="openModal('login-modal')">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
                </div>
            </div>
        `;
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Overlay ‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå CSS
        return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    }
    // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---

    if (!missionsLoaded) {
        container.innerHTML = '<div style="text-align:center; padding: 50px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>';
        return;
    }
    
    const submissionMap = currentUserSubmissions.length > 0 
        ? new Map(currentUserSubmissions.map(task => [task.task, task]))
        : new Map();

    const sortedMissions = [...allMissions].sort((a, b) => {
        const aSub = submissionMap.get(a.topic);
        const bSub = submissionMap.get(b.topic);
        
        const aIsSubmitted = aSub && aSub.status !== '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á';
        const bIsSubmitted = bSub && bSub.status !== '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á';
        
        if (!aIsSubmitted && bIsSubmitted) return -1;
        if (aIsSubmitted && !bIsSubmitted) return 1;

        if (!aIsSubmitted && !bIsSubmitted) {
            if (a.urgency === 'urgent' && b.urgency !== 'urgent') return -1;
            if (b.urgency === 'urgent' && a.urgency !== 'urgent') return 1;
            return a.dueDate - b.dueDate;
        }
        
        if (aIsSubmitted && bIsSubmitted) {
            return b.dueDate - a.dueDate;
        }

        return 0;
    });
    
    let missionHtml = '';
    sortedMissions.forEach((mission, index) => {
        let statusClass = '';
        let iconHtml = '...';

        const sub = submissionMap.get(mission.topic);

        if (sub && sub.status === '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß') {
            statusClass = 'completed';
            iconHtml = `‚úîÔ∏è ${sub.score}`;
        } else if (sub && sub.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à') {
            statusClass = 'completed pending';
            iconHtml = '‚åõ';
        } else { 
            if (mission.timingStatus === 'active') {
                statusClass = 'available';
                if (mission.urgency === 'urgent') statusClass += ' urgent-node';
                iconHtml = `<b>${mission.maxPoints}</b><small>pt</small>`;
            } else {
                statusClass = 'locked';
                if (mission.timingStatus === 'past') statusClass += ' overdue-node';
                iconHtml = 'üîí';
            }
        }
        
        const rowClass = (index % 2 === 0) ? 'mission-row-left' : 'mission-row-right';
        missionHtml += `
          <div class="mission-row ${rowClass}">
            <div class="mission-node ${statusClass}" onclick="showMissionDetail('${mission.topic}')" title="${mission.topic}">
              <div class="mission-node-topic">${mission.topic}</div>
              <div class="mission-node-points">${iconHtml}</div> 
            </div>
          </div>
        `;
    });
    
    container.innerHTML = missionHtml || '<div style="text-align:center; padding: 50px; color: #fff;">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
}

    function showMissionDetail(topic) {
    const mission = allMissions.find(m => m.topic === topic);
    if (!mission) return;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Action ‡πÉ‡∏î‡πÜ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    if (!currentUser) {
        document.getElementById('modal-mission-topic').innerText = mission.topic;
        document.getElementById('modal-mission-detail').innerText = mission.detail || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)';
        document.getElementById('modal-mission-maxPoints').innerText = `${mission.maxPoints} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
        document.getElementById('modal-mission-dueDate').innerText = `‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${mission.dueDateString}`;
        
        const userStatusEl = document.getElementById('modal-mission-user-status');
        const actionsContainer = document.getElementById('modal-mission-actions');

        userStatusEl.innerHTML = `<span style="color: var(--status-pending);">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ</span>`;
        actionsContainer.innerHTML = `<button class="btn-primary" onclick="openModal('login-modal'); closeModal('mission-detail-modal');">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button> <button class="btn-secondary" onclick="closeModal('mission-detail-modal')">‡∏õ‡∏¥‡∏î</button>`;
        
        openModal('mission-detail-modal');
        return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    }
    // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

    const submission = currentUserSubmissions.find(s => s.task === topic);

    document.getElementById('modal-mission-topic').innerText = mission.topic;
    document.getElementById('modal-mission-detail').innerText = mission.detail || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)';
    document.getElementById('modal-mission-maxPoints').innerText = `${mission.maxPoints} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;

    const isActuallySubmitted = submission && submission.status !== '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á';
    const dueDateEl = document.getElementById('modal-mission-dueDate');
    let deadlineText = `‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${mission.dueDateString}`;
    if (mission.urgency === 'urgent' && !isActuallySubmitted) {
        deadlineText += ' <span style="color: #e74c3c; font-weight: bold;">(‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï!)</span>';
    } else if (mission.timingStatus === 'past' && !isActuallySubmitted) {
        deadlineText += ' <span style="color: #95a5a6; font-weight: bold;">(‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á)</span>';
    }
    dueDateEl.innerHTML = deadlineText;
    
    const userStatusEl = document.getElementById('modal-mission-user-status');
    const actionsContainer = document.getElementById('modal-mission-actions');
    
    let actionsHtml = `<button class="btn-secondary" onclick="closeModal('mission-detail-modal')">‡∏õ‡∏¥‡∏î</button>`;
    
    if (submission && submission.status === '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß') {
        userStatusEl.innerHTML = `<span style="color: var(--status-graded); font-weight: bold;">‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏î‡πâ ${submission.score} / ${mission.maxPoints} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ‚úîÔ∏è</span>`;
    } else if (submission && submission.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à') {
        userStatusEl.innerHTML = `<span style="color: var(--status-pending); font-weight: bold;">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö) ‚åõ</span>`;
        actionsHtml = `<button class="btn-primary" onclick="openSubmissionModal('${mission.topic}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>` + actionsHtml;
    } else { 
        if (mission.timingStatus === 'active') {
            userStatusEl.innerHTML = `<span style="font-weight: bold; color: var(--gold-color);">‡∏£‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</span>`;
            actionsHtml = `<button class="btn-primary" onclick="openSubmissionModal('${mission.topic}')">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>` + actionsHtml;
        } else if (mission.timingStatus === 'upcoming') {
            userStatusEl.innerHTML = `<span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${mission.assignedDateString})</span>`;
        } else {
            userStatusEl.innerHTML = `<span style="color: #e74c3c;">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`;
        }
    }

    actionsContainer.innerHTML = actionsHtml;
    
    openModal('mission-detail-modal');
}

    function openSubmissionModal(topic) {
        currentMissionTopic = topic;

        document.getElementById('submission-form-area').style.display = 'block';
        document.getElementById('submission-loader').style.display = 'none';
        document.getElementById('submission-buttons').style.display = 'block';
        document.getElementById('submission-link').value = '';
        document.getElementById('submission-file').value = '';
        document.getElementById('file-upload-status').innerText = '';
        document.getElementById('submission-error').innerText = '';
        document.getElementById('submission-modal-topic').innerText = topic;

        closeModal('mission-detail-modal');
        openModal('submission-modal');
    }

    async function handleSubmitMission() {
        const errorEl = document.getElementById('submission-error');
        const link = document.getElementById('submission-link').value.trim();
        const fileInput = document.getElementById('submission-file');
        const file = fileInput.files[0];

        if (!link && !file) {
            errorEl.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á';
            return;
        }

        document.getElementById('submission-form-area').style.display = 'none';
        document.getElementById('submission-buttons').style.display = 'none';
        document.getElementById('submission-loader').style.display = 'block';
        errorEl.innerText = '';

        let proofUrl = '';

        if (file) {
            try {
                document.getElementById('submission-loader-text').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

                const urlResponse = await postAdminAction('createUploadUrl', {
                    fileType: file.type,
                    missionTopic: currentMissionTopic
                });

                if (!urlResponse.success) throw new Error(urlResponse.error);

                document.getElementById('submission-loader-text').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...';
                const uploadResponse = await fetch(urlResponse.uploadUrl, {
                    method: 'PUT',
                    body: file,
                    headers: { 'Content-Type': file.type }
                });

                if (!uploadResponse.ok) throw new Error('‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');

                // We need to get the file link from Drive. This requires an OAuth token.
                // We'll call a dedicated Apps Script function for this.
                const fileLinkResponse = await new Promise((resolve, reject) => {
                    // This is an example, you would need a function in Apps Script to get the file link
                    // for now, let's assume it's part of the createUploadUrl response for simplicity
                    // In a real scenario, you'd need a robust way to get the file link.
                    // For now, let's just make the link from a known pattern (less reliable)
                    // The 'alternateLink' is not immediately available.
                    // A better way is to have the server-side script that creates the URL also return the final file ID.
                    // But for now, we'll assume a delay and then a check.
                    // This is a complex part of Drive API integration.
                    // The proofUrl should ideally be constructed/retrieved on the server.
                    // We'll simulate this with a small delay.
                    setTimeout(async () => {
                         try {
                            // This part is tricky because getting the alternateLink right after upload is not guaranteed.
                            // We will just pass the filename and let the server-side find it.
                            // Let's modify the `submitMission` to accept the fileName instead.
                            resolve({ success: true });
                         } catch (e) { reject(e); }
                    }, 3000); // Wait 3 seconds for file to be available
                });
                // This part is simplified. A real app needs a more robust way to get the file link.
                // For this project, we'll assume the server can find the file.
                // The `proofUrl` can be constructed later or searched for by the server.

            } catch (error) {
                errorEl.innerText = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ${error.message}`;
                document.getElementById('submission-form-area').style.display = 'block';
                document.getElementById('submission-buttons').style.display = 'block';
                document.getElementById('submission-loader').style.display = 'none';
                return;
            }
        }
        
        // This is a simplified version. The proofUrl should be reliably obtained.
        // For now, let's just use a placeholder or handle it server-side.
        // The most reliable way is for `createUploadUrl` to return a file ID,
        // which we can then use to construct a URL.

        try {
            document.getElementById('submission-loader-text').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            // We pass the filename to the server, and it will construct the proofUrl
            const submissionResult = await postAdminAction('submitMission', {
                missionTopic: currentMissionTopic,
                submissionLink: link,
                // Passing filename for server to resolve the URL.
                fileName: file ? file.name : null 
            });

            if (submissionResult.success) {
                showToast(submissionResult.message);
                closeModal('submission-modal');
                await loadInitialData();
            } else {
                throw new Error(submissionResult.error);
            }
        } catch (error) {
            errorEl.innerText = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`;
            document.getElementById('submission-form-area').style.display = 'block';
            document.getElementById('submission-buttons').style.display = 'block';
            document.getElementById('submission-loader').style.display = 'none';
        }
    }


    function filterStudentList() {
        const searchTerm = document.getElementById('search-student').value.toLowerCase();
        filteredSummaryData = searchTerm ? fullSummaryData.filter(s => s.name.toLowerCase().includes(searchTerm)) : [...fullSummaryData];
        renderStudentList();
    }

    function handleUserAreaClick() { currentUser ? openModal("profile-modal") : openModal("login-modal"); }
    function openModal(id) { document.getElementById(id)?.classList.add("visible"); }
    function closeModal(id) { document.getElementById(id)?.classList.remove("visible"); }

    async function showStudentDetailModal(studentId) {
        const student = fullSummaryData.find(s => String(s.studentId) === String(studentId));
        if (!student) return;

        document.getElementById('detail-modal-pic').src = student.profileUrl || 'https://i.ibb.co/RkgFJztg/AVATAR.jpg';
        document.getElementById('detail-modal-name').innerText = student.name;
        document.getElementById('detail-modal-score').innerText = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${student.totalScore}`;
        document.getElementById('detail-modal-badges').innerHTML = (student.earnedBadges || []).map(b => `<div class="badge-tooltip"><img src="${b.iconUrl}" alt="${b.name}" class="badge-icon"><span class="tooltip-text"><b>${b.name}</b><br>${b.description}</span></div>`).join('');

        const body = document.getElementById('detail-modal-body');
        body.innerHTML = '<div style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</div>';
        openModal('student-detail-modal');

        try {
            const result = await fetchGet({ action: "getStudentDetail", studentId: studentId });
            if (result.error) throw new Error(result.error);
            displayDetailsInModal(result.data);
        } catch (err) {
            body.innerHTML = `<p style="color: var(--danger-color); text-align: center;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</p>`;
        }
    }

    function switchView(viewId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tabElement = document.querySelector(`.tab[onclick="switchView('${viewId}')"]`);
        if (tabElement) {
            tabElement.classList.add('active');
        }

        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
        const viewElement = document.getElementById(viewId);
        if (viewElement) {
            viewElement.classList.add('active');
        }

        if (viewId === 'map-view-container') {
            renderMapView();
        }
        else if (viewId === 'admin-view') {
            loadAdminData();
        }
    }

    function displayDetailsInModal(data) {
        if (!data || !data.tasks) {
            document.getElementById('detail-modal-body').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>';
            return;
        }
        document.getElementById('detail-modal-score').innerText = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${data.summary.totalScore}`;
        let tableHtml = `<table class="detail-table"><thead><tr><th>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</th><th style="text-align:center;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th style="text-align:right;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead><tbody>`;
        data.tasks.forEach(item => {
            let statusClass = '', statusText = '';
            switch (item.status) {
                case '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß': statusClass = 'graded'; statusText = `<i class="fas fa-check-circle"></i> ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß`; break;
                case '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à': statusClass = 'pending'; statusText = `‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à`; break;
                default: statusClass = 'not-submitted'; statusText = '‚úó ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á';
            }
            tableHtml += `<tr><td>${item.task}</td><td class="status ${statusClass}" align="center">${statusText}</td><td align="right">${item.score} / ${item.maxPoints}</td></tr>`;
        });
        tableHtml += '</tbody></table>';
        document.getElementById('detail-modal-body').innerHTML = tableHtml;
    }

    function showLoader(show, text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
        const loader = document.getElementById('initial-loader');
        const mainContent = document.getElementById('main-content-wrapper');
        if (show) {
            if (loader) loader.style.display = 'block';
            if (loader) loader.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
            if (mainContent) mainContent.style.display = 'none';
        } else {
            if (loader) loader.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
        }
    }

    function showError(error) {
        console.error(error);
        const errorMsg = (error && error.message) ? error.message : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏";
        const appContainer = document.getElementById('app-container');
        if (appContainer) {
            appContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #ffb8b8; background: rgba(0,0,0,0.3); border-radius: 10px;"><h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p>${errorMsg}</p></div>`;
        }
    }

    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        if (isError) {
            toast.classList.add('error');
        }
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300);
        }, 4000);
    }
</script>
