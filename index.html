<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENG NPC 68 QUEST</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="app-container">
        <!-- Initial Loader -->
        <div id="initial-loader">
            <div class="loader-icon"><i class="fas fa-spinner"></i></div>
            <div class="loader-text">Loading Quest...</div>
        </div>

        <!-- Main App Structure -->
        <div id="main-app-wrapper" style="display: none;"></div>
    </div>
    
    <!-- Modals will be built here, but the Story Viewer is separate -->
    <div id="modals-container"></div>
    <div id="story-viewer-container"></div>
    <div id="toast-container"></div>

<script>
    // ======================================================
    // CONFIGURATION & GLOBAL STATE
    // ======================================================
    const SUPABASE_URL = 'https://nmykdendjmttjvvtsuxk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5teWtkZW5kam10dGp2dnRzdXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mzk4MTksImV4cCI6MjA2ODMxNTgxOX0.gp1hzku2fDBH_9PvMsDCIwlkM0mssuke40smgU4-paE';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const DEFAULT_AVATAR = 'https://i.ibb.co/RkgFJztg/AVATAR.jpg';
    
    const AppState = {
        currentUser: null,
        leaderboard: [],
        missions: [],
        submissions: new Map(),
        badges: [],
        currentView: 'feed',
        config: getGradeConfigFromUrl()
    };

    // ======================================================
    // INITIALIZATION
    // ======================================================
    window.addEventListener('load', initializeApp);

    function getGradeConfigFromUrl() {
        const hostname = window.location.hostname;
        if (hostname.includes('eng-m1')) return { level: '‡∏°.1', title: 'M.1' };
        if (hostname.includes('eng-m2')) return { level: '‡∏°.2', title: 'M.2' };
        return { level: '‡∏°.3', title: 'M.3' };
    }

    async function initializeApp() {
        document.title = `English Quest - ${AppState.config.title}`;
        buildAppShell();
        initializeUserFromStorage();
        await loadInitialData();
        
        document.getElementById('initial-loader').style.display = 'none';
        document.getElementById('main-app-wrapper').style.display = 'flex';
    }

    // ======================================================
    // DATA FETCHING
    // ======================================================
    async function loadInitialData() {
        try {
            const [leaderboardRes, missionsRes, submissionsRes] = await Promise.all([
                supabaseClient.from('users').select('*').eq('role', 'student').eq('level', AppState.config.level).order('total_score', { ascending: false, nullsFirst: false }),
                supabaseClient.from('missions').select('*').eq('level', AppState.config.level).order('id', { ascending: true }),
                AppState.currentUser ? supabaseClient.from('submissions').select('mission_id, score').eq('user_id', AppState.currentUser.id) : Promise.resolve({ data: [] })
            ]);

            if (leaderboardRes.error) throw leaderboardRes.error;
            if (missionsRes.error) throw missionsRes.error;
            if (submissionsRes.error) throw submissionsRes.error;
            
            AppState.leaderboard = leaderboardRes.data;
            AppState.missions = missionsRes.data;
            AppState.submissions = new Map((submissionsRes.data || []).map(s => [s.mission_id, s]));
            
            renderMainHub(); // Initial render
        } catch (error) {
            showError(error);
        }
    }

    // ======================================================
    // UI SHELL & MAIN HUB
    // ======================================================
    function buildAppShell() {
        const wrapper = document.getElementById('main-app-wrapper');
        wrapper.innerHTML = `
            <header class="hub-header">
                <h1 class="header-title">English Quest</h1>
                <button id="profile-button">
                    <img src="${DEFAULT_AVATAR}" alt="Profile">
                </button>
            </header>
            <div id="main-content"></div>
        `;
        document.getElementById('profile-button').addEventListener('click', () => {
            if (AppState.currentUser) {
                // Open Profile Story/Modal
            } else {
                openLoginModal();
            }
        });
    }

    function renderMainHub() {
        const mainContent = document.getElementById('main-content');
        if (!mainContent) return;

        // Render Story Highlights
        const storyHighlightsHTML = `
            <div class="story-highlights-container">
                <div class="story-highlight-item" onclick="showStory('leaderboard')">
                    <div class="story-highlight-icon-wrapper">
                        <div class="story-highlight-icon">üèÜ</div>
                    </div>
                    <span class="story-highlight-label">Top 3</span>
                </div>
                <div class="story-highlight-item" onclick="showStory('mission')">
                    <div class="story-highlight-icon-wrapper">
                        <div class="story-highlight-icon">‚ú®</div>
                    </div>
                    <span class="story-highlight-label">New Mission</span>
                </div>
                 <div class="story-highlight-item" onclick="showStory('profile')">
                    <div class="story-highlight-icon-wrapper">
                        <div class="story-highlight-icon">üìä</div>
                    </div>
                    <span class="story-highlight-label">My Stats</span>
                </div>
            </div>
        `;

        // Render Activity Feed
        const activityFeedHTML = `
            <div class="activity-feed-container">
                <div class="feed-item">
                    <img src="${DEFAULT_AVATAR}" class="feed-avatar">
                    <div>
                        <div class="feed-content"><b>Teacher</b> posted a new mission: <b>Final Project</b>!</div>
                        <div class="feed-time">1h ago</div>
                    </div>
                </div>
                 <div class="feed-item">
                    <img src="${DEFAULT_AVATAR}" class="feed-avatar">
                    <div>
                        <div class="feed-content"><b>John Doe</b> scored <b>100 PTS</b> on <b>Grammar Test</b>! üéâ</div>
                        <div class="feed-time">2h ago</div>
                        <div class="feed-actions">
                            <button class="clap-button">üëè</button>
                            <span class="clap-count">5</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        mainContent.innerHTML = storyHighlightsHTML + activityFeedHTML;
        
        // Update profile button in header
        const profileButtonImg = document.querySelector('#profile-button img');
        if (profileButtonImg) {
            profileButtonImg.src = AppState.currentUser ? AppState.currentUser.profile_url || DEFAULT_AVATAR : DEFAULT_AVATAR;
        }
    }

    // ======================================================
    // STORY VIEWER LOGIC
    // ======================================================
    let storyTimer;
    
    function showStory(type) {
        const container = document.getElementById('story-viewer-container');
        if (!container) return;

        let pagesHTML = '';
        if (type === 'leaderboard') {
            const top3 = AppState.leaderboard.slice(0, 3);
            const others = AppState.leaderboard.slice(3, 10);
            
            pagesHTML = `
                <!-- Page 1: Rank 1 -->
                <div class="story-page leaderboard" data-duration="5000">
                    <div class="podium-rank-icon">üëë</div>
                    <img src="${top3[0]?.profile_url || DEFAULT_AVATAR}" class="podium-avatar">
                    <div class="podium-name">${top3[0]?.name || 'N/A'}</div>
                    <div class="podium-score">${top3[0]?.total_score || 0} XP</div>
                </div>
                <!-- Page 2: Rank 2 & 3 -->
                <div class="story-page leaderboard" data-duration="5000">
                    <div class="leaderboard-story-grid">
                        <div>
                            <div class="podium-rank-icon">ü•à</div>
                            <img src="${top3[1]?.profile_url || DEFAULT_AVATAR}" class="podium-avatar">
                            <div class="podium-name">${top3[1]?.name || 'N/A'}</div>
                            <div class="podium-score">${top3[1]?.total_score || 0} XP</div>
                        </div>
                        <div>
                            <div class="podium-rank-icon">ü•â</div>
                            <img src="${top3[2]?.profile_url || DEFAULT_AVATAR}" class="podium-avatar">
                            <div class="podium-name">${top3[2]?.name || 'N/A'}</div>
                            <div class="podium-score">${top3[2]?.total_score || 0} XP</div>
                        </div>
                    </div>
                </div>
                 <!-- Page 3: Roster -->
                <div class="story-page leaderboard" data-duration="10000">
                    <h3>Top 10 Challengers</h3>
                    <ul class="roster-story-list">
                        ${[...top3, ...others].map(user => `
                            <li class="roster-story-item">
                                <span class="rank">${user.rank}</span>
                                <img src="${user.profile_url || DEFAULT_AVATAR}" class="avatar">
                                <span class="name">${user.name}</span>
                                <span class="score">${user.total_score || 0} XP</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        } else if (type === 'mission') {
            const latestMission = AppState.missions[AppState.missions.length - 1] || { topic: 'No new missions', detail: 'Check back later!' };
            pagesHTML = `
                 <div class="story-page mission" data-duration="7000">
                    <div class="mission-icon">‚ú®</div>
                    <h2 class="mission-title">${latestMission.topic}</h2>
                    <p class="mission-details">${latestMission.detail}</p>
                    <div class="mission-info-bar">
                        <span>üèÜ ${latestMission.max_points || 0} XP</span>
                        <span>üìÖ Due: ${latestMission.due_date ? new Date(latestMission.due_date).toLocaleDateString('th-TH') : 'N/A'}</span>
                    </div>
                    <button class="mission-button">View Mission</button>
                 </div>
            `;
        } else {
            // Placeholder for Profile/Event stories
            pagesHTML = `<div class="story-page" data-duration="3000"><h2>Story for ${type} coming soon!</h2></div>`;
        }

        container.innerHTML = `
            <div class="story-viewer-overlay visible">
                <div class="story-viewer-container">
                    <div class="story-progress-bar-container"></div>
                    <div class="story-header">
                        <div></div> <!-- Placeholder for user info -->
                        <div class="story-close-button" onclick="closeStory()">√ó</div>
                    </div>
                    <div class="story-nav-left" onclick="prevStory()"></div>
                    <div class="story-nav-right" onclick="nextStory()"></div>
                    ${pagesHTML}
                </div>
            </div>
        `;
        
        startStoryPlayback();
    }
    
    function startStoryPlayback() {
        const pages = document.querySelectorAll('.story-page');
        if (pages.length === 0) return;

        const progressBarContainer = document.querySelector('.story-progress-bar-container');
        progressBarContainer.innerHTML = Array.from(pages).map(() => `<div class="story-progress-bar"><div class="story-progress-bar-fill"></div></div>`).join('');
        
        let currentPageIndex = 0;

            const progressBars = document.querySelectorAll('.story-progress-bar');
        
        function playPage(index) {
            if (index < 0 || index >= pages.length) {
                closeStory();
                return;
            }
            currentPageIndex = index;
            
            pages.forEach((page, i) => page.classList.toggle('active', i === index));
            progressBars.forEach((bar, i) => {
                const fill = bar.querySelector('.story-progress-bar-fill');
                if (i < index) fill.style.width = '100%';
                else if (i === index) fill.style.width = '0%';
                else fill.style.width = '0%';
            });
            
            const currentFill = progressBars[index].querySelector('.story-progress-bar-fill');
            const duration = pages[index].dataset.duration || 5000;
            
            // Force reflow to restart animation
            currentFill.style.transitionDuration = '0s';
            currentFill.style.width = '0%';
            void currentFill.offsetWidth; // Reflow trick
            currentFill.style.transitionDuration = `${duration / 1000}s`;
            currentFill.style.width = '100%';

            clearTimeout(storyTimer);
            storyTimer = setTimeout(() => playPage(index + 1), duration);
        }

        window.nextStory = () => playPage(currentPageIndex + 1);
        window.prevStory = () => playPage(currentPageIndex - 1);

        playPage(0);
    }
    
    function closeStory() {
        clearTimeout(storyTimer);
        const viewer = document.querySelector('.story-viewer-overlay');
        if(viewer) {
            viewer.classList.remove('visible');
            // Remove after transition to clean up DOM
            setTimeout(() => {
                viewer.remove();
            }, 300);
        }
    }

    // ======================================================
    // USER MANAGEMENT & MODALS
    // ======================================================
    function initializeUserFromStorage() {
        const userJson = localStorage.getItem('leaderboardUser');
        if (userJson) {
            try {
                const parsedData = JSON.parse(userJson);
                if (typeof parsedData === 'object' && parsedData.id) AppState.currentUser = parsedData;
            } catch (e) {
                localStorage.removeItem('leaderboardUser');
            }
        }
    }

    async function handleLogin() {
        const username = document.getElementById('username-input').value.trim();
        const password = document.getElementById('password-input').value.trim();
        const errorEl = document.getElementById('login-error');
        if (!username || !password) { errorEl.innerText = "Please fill all fields."; return; }
        errorEl.innerText = "Verifying...";
        const { data, error } = await supabaseClient.from('users').select('*').eq('username', username).eq('password', password).single();
        if (error || !data) {
            errorEl.innerText = "Incorrect username or password.";
        } else {
            localStorage.setItem('leaderboardUser', JSON.stringify(data));
            location.reload(); 
        }
    }
    
    function openLoginModal() {
        const container = document.getElementById('modals-container');
        container.innerHTML = `
            <div id="login-modal" class="modal-overlay visible">
                <div class="modal-box">
                    <div class="modal-close" onclick="closeModal()">√ó</div>
                    <h2>Login</h2>
                    <form onsubmit="event.preventDefault(); handleLogin();">
                        <div id="login-error" class="modal-error"></div>
                        <input type="text" id="username-input" placeholder="Username">
                        <input type="password" id="password-input" placeholder="Password">
                        <button type="submit" class="btn-primary">Enter</button>
                    </form>
                </div>
            </div>`;
    }

    // ======================================================
    // UTILITIES
    // ======================================================
    function showError(error) {
        console.error(error);
        const errorMsg = (error && error.message) ? error.message : "An unknown error occurred.";
        document.getElementById('app-container').innerHTML = `<div style="padding:20px;text-align:center;color:var(--status-danger);"><h3>Oops!</h3><p>${errorMsg}</p></div>`;
    }

    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast-notification ${isError ? 'error' : ''}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300);
        }, 3000);
    }
    
    function closeModal() {
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.classList.remove('visible');
            // Remove after transition
            setTimeout(() => m.remove(), 300);
        });
    }

</script>
</body>
</html>
